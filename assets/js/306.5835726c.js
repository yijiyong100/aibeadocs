(window.webpackJsonp=window.webpackJsonp||[]).push([[306],{822:function(s,a,t){"use strict";t.r(a);var e=t(53),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("本文主要是介绍 MySQL负载均衡介绍 。")])]),s._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#_1、简介"}},[s._v("1、简介")])]),t("li",[t("a",{attrs:{href:"#_2、基本环境"}},[s._v("2、基本环境")])]),t("li",[t("a",{attrs:{href:"#_3、配置mysql主主复制"}},[s._v("3、配置MySQL主主复制")])]),t("li",[t("a",{attrs:{href:"#_4、中间件简述"}},[s._v("4、中间件简述")]),t("ul",[t("li",[t("a",{attrs:{href:"#_4-1、haproxy-介绍"}},[s._v("4.1、Haproxy 介绍")])]),t("li",[t("a",{attrs:{href:"#_4-2、keepalived-介绍"}},[s._v("4.2、keepalived 介绍")])])])]),t("li",[t("a",{attrs:{href:"#_5、中间件的安装与配置-haproxy、keepalived"}},[s._v("5、中间件的安装与配置（haproxy、keepalived）")]),t("ul",[t("li",[t("a",{attrs:{href:"#_5-1、安装haproxy"}},[s._v("5.1、安装haproxy")])]),t("li",[t("a",{attrs:{href:"#_1-、编译安装haproxy"}},[s._v("1）、编译安装haproxy")])]),t("li",[t("a",{attrs:{href:"#_2-、提供启动脚本"}},[s._v("2）、提供启动脚本")])]),t("li",[t("a",{attrs:{href:"#_3-、提供配置文件"}},[s._v("3）、提供配置文件")])]),t("li",[t("a",{attrs:{href:"#_4-、启动日志"}},[s._v("4）、启动日志")])]),t("li",[t("a",{attrs:{href:"#_5-、启动haproxy"}},[s._v("5）、启动haproxy")])]),t("li",[t("a",{attrs:{href:"#_6-、测试haproxy"}},[s._v("6）、测试haproxy")])]),t("li",[t("a",{attrs:{href:"#_5-2、安装keepalived"}},[s._v("5.2、安装keepalived")])]),t("li",[t("a",{attrs:{href:"#_1-、解决缺少的软件库文件"}},[s._v("1）、解决缺少的软件库文件")])]),t("li",[t("a",{attrs:{href:"#_2-、编译安装keepalived软件"}},[s._v("2）、编译安装keepalived软件")])]),t("li",[t("a",{attrs:{href:"#_3-、创建配置文件"}},[s._v("3）、创建配置文件")])]),t("li",[t("a",{attrs:{href:"#_4-、创建脚本文件"}},[s._v("4）、创建脚本文件")])])])]),t("li",[t("a",{attrs:{href:"#_6、功能测试"}},[s._v("6、功能测试")]),t("ul",[t("li",[t("a",{attrs:{href:"#_6-1、流程简述"}},[s._v("6.1、流程简述")])]),t("li",[t("a",{attrs:{href:"#_6-2、测试haproxy监听前端端口3306"}},[s._v("6.2、测试haproxy监听前端端口3306")])]),t("li",[t("a",{attrs:{href:"#_6-3、测试高可用-keepalived不抢占vip"}},[s._v("6.3、测试高可用+keepalived不抢占vip")])]),t("li",[t("a",{attrs:{href:"#_6-4、测试负载均衡"}},[s._v("6.4、测试负载均衡")])])])]),t("li",[t("a",{attrs:{href:"#_7、总结与建议"}},[s._v("7、总结与建议")])]),t("li",[t("a",{attrs:{href:"#参考文章"}},[s._v("参考文章")])])])]),t("p"),s._v(" "),t("p",[s._v("搭建MySQL高可用负载均衡集群")]),s._v(" "),t("p",[t("strong",[s._v("阅读目录")])]),s._v(" "),t("h2",{attrs:{id:"_1、简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、简介"}},[s._v("#")]),s._v(" 1、简介")]),s._v(" "),t("p",[s._v("使用MySQL时随着时间的增长，用户量以及数据量的逐渐增加，访问量更是剧增，最终将会使MySQL达到某个瓶颈，那么MySQL的性能将会大大降低。这一结果也不利于软件的推广。")]),s._v(" "),t("p",[s._v("那么如何跨过这个瓶颈，提高MySQL的并发量呢？方法有很多，分布式数据库、读写分离、高可用负载均衡、增加缓存服务器等等。之前的文章里已经介绍了读写分离的方案了，接下来我将讲解MySQL高可用负载均衡这一方法。")]),s._v(" "),t("p",[s._v("其中实现高可用负载均衡的方法有很多，例如LVS+keepalived组合实现、haproxy+keepalived组合实现等等，这里我们采用haproxy+keepalived组合实现MySQL高可用负载均衡这一技术。")]),s._v(" "),t("h2",{attrs:{id:"_2、基本环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、基本环境"}},[s._v("#")]),s._v(" 2、基本环境")]),s._v(" "),t("p",[s._v("四台linux虚拟主机")]),s._v(" "),t("p",[s._v("Linux版本CentOS6.6")]),s._v(" "),t("p",[s._v("MySQL 5.5（已安装好）")]),s._v(" "),t("p",[s._v("haproxy-1.5.14")]),s._v(" "),t("p",[s._v("keepalived-1.2.19")]),s._v(" "),t("p",[s._v("IP：192.168.95.11（mysql1）、192.168.95.12（mysql2）、192.168.95.13（haproxy+keepalived）、192.168.95.14（haproxy+keepalived）、192.168.95.55（vip）")]),s._v(" "),t("h2",{attrs:{id:"_3、配置mysql主主复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、配置mysql主主复制"}},[s._v("#")]),s._v(" 3、配置MySQL主主复制")]),s._v(" "),t("p",[s._v("详细配置步骤可以参考这篇文章：")]),s._v(" "),t("p",[s._v("http://www.cnblogs.com/phpstudy2015-6/p/6485819.html#_label7")]),s._v(" "),t("p",[s._v("以下简要介绍一下mysql的主主复制：")]),s._v(" "),t("p",[s._v("何为主主复制？就是两个mysql都能读能写，数据记录通过二进制传达给对方从而保持数据的一致性。")]),s._v(" "),t("p",[t("strong",[s._v("（192.168.95.11"),t("strong",[t("strong",[s._v("主从复制+192.168.95.12")])]),s._v("主从复制==192.168.95.11")]),s._v("**、192.168.95.12****主主复制）**")]),s._v(" "),t("p",[s._v("因此主主复制中必须要解决的事情就是自增主键的问题。如果mysql1主键id增加到12了，此时二进制数据还没到达mysql2，那么mysql2恰好要插入数据，那么新数据主键id也是12，那不就是乱套了么！解决这一问题我们可以直接更改MySQL中的配置文件即可。")]),s._v(" "),t("p",[t("strong",[s._v("1")]),s._v("**）、更改配置文件**")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--192.168.95.11：MySQL")]),s._v("\nserver"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#任意自然数n，只要保证两台MySQL主机不重复就可以了。")]),s._v("\nlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启二进制日志")]),s._v("\nauto_increment_increment"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#步进值auto_imcrement。一般有n台主MySQL就填n")]),s._v("\nauto_increment_offset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#起始值。一般填第n台主MySQL。此时为第一台主MySQL")]),s._v("\nbinlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ignore")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#忽略mysql库【我一般都不写】")]),s._v("\nbinlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ignore")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("information_schema   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#忽略information_schema库【我一般都不写】")]),s._v("\nreplicate"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("aa   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#要同步的数据库，默认所有库")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--192.168.95.12：MySQL")]),s._v("\nserver"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("\nlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin\nauto_increment_increment"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nauto_increment_offset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nreplicate"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("aa\n")])])]),t("p",[s._v("配置好后重启MySQL")]),s._v(" "),t("p",[t("strong",[s._v("2")]),s._v("**）、配置192.168.95.11****主从复制**")]),s._v(" "),t("p",[s._v("1、在192.168.95.12中创建一个192.168.95.11主机中可以登录的MySQL用户")]),s._v(" "),t("p",[s._v("用户：mysql11")]),s._v(" "),t("p",[s._v("密码：mysql11")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPLICATION")]),s._v(" SLAVE "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" ‘mysql11’@’"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".95")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".11")]),s._v("’ IDENTIFIED "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" ’mysql11’"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("FLUSH "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("2、查看192.168.95.12二进制日志")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" master "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413215414955-1866659756.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("3、告知二进制文件名与位置")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" change master "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" master_host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.95.11'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" master_user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql11'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("master_password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql11'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("master_log_file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000097'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" master_log_pos"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("107")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("4、查看结果")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v("\\G\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413215523876-1824558273.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("配置主从复制成功")]),s._v(" "),t("p",[t("strong",[s._v("3")]),s._v("**）、配置192.168.95.12****主从复制**")]),s._v(" "),t("p",[s._v("同上")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413215609611-1788666291.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("配置主从复制成功。")]),s._v(" "),t("h2",{attrs:{id:"_4、中间件简述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、中间件简述"}},[s._v("#")]),s._v(" 4、中间件简述")]),s._v(" "),t("h3",{attrs:{id:"_4-1、haproxy-介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1、haproxy-介绍"}},[s._v("#")]),s._v(" 4.1、Haproxy 介绍")]),s._v(" "),t("p",[s._v("Haproxy是一个开源的高性能的反向代理或者说是负载均衡服务软件之一，它支持双机热备、虚拟主机、基于TCP和HTTP应用代理等功能。其配置简单，而且拥有很好的对服务器节点的健康检查功能（相当于keepalived健康检查），当其代理的后端服务器出现故障时，Haproxy会自动的将该故障服务器摘除，当服务器的故障恢复后Haproxy还会自动将RS服务器。")]),s._v(" "),t("p",[s._v("HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。")]),s._v(" "),t("p",[s._v("Haproxy软件引入了frontend，backend的功能，frontend（acl规则匹配）可以根据任意HTTP请求头做规则匹配，然后把请求定向到相关的backend（server pools等待前端把请求转过来的服务器组）。通过frontend和backup，我们可以很容易的实现haproxy的7层代理功能，haproxy是一款不可多得的优秀代理服务软件。")]),s._v(" "),t("h3",{attrs:{id:"_4-2、keepalived-介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2、keepalived-介绍"}},[s._v("#")]),s._v(" 4.2、keepalived 介绍")]),s._v(" "),t("p",[s._v("keepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即虚拟路由冗余协议。")]),s._v(" "),t("p",[s._v("虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到vrrp包时就认为master宕掉了，这时就需要根据VRRP的优先级来选举一个backup当master。这样的话就可以保证路由器的高可用了。")]),s._v(" "),t("p",[s._v("keepalived主要有三个模块，分别是core、check和vrrp。core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。check负责健康检查，包括常见的各种检查方式。vrrp模块是来实现VRRP协议的。")]),s._v(" "),t("h2",{attrs:{id:"_5、中间件的安装与配置-haproxy、keepalived"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5、中间件的安装与配置-haproxy、keepalived"}},[s._v("#")]),s._v(" 5、中间件的安装与配置（haproxy、keepalived）")]),s._v(" "),t("p",[s._v("百度云下载：链接：https://pan.baidu.com/s/13INX99ToeqRoZcaTHb1L8A 密码：0lmp")]),s._v(" "),t("h3",{attrs:{id:"_5-1、安装haproxy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1、安装haproxy"}},[s._v("#")]),s._v(" 5.1、安装haproxy")]),s._v(" "),t("p",[s._v("在192.168.95.13、192.168.95.14安装haproxy（一模一样安装）")]),s._v(" "),t("h3",{attrs:{id:"_1-、编译安装haproxy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-、编译安装haproxy"}},[s._v("#")]),s._v(" 1）、编译安装haproxy")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar -zxvf haproxy-1.5.14.tar.gz")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd haproxy-1.5.14")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make TARGET=linux26 ARCH=x86_64 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make install SBINDIR=/usr/sbin/ MANDIR=/usr/share/man/ DOCDIR=/usr/share/doc/")]),s._v("\n")])])]),t("p",[s._v("注意：")]),s._v(" "),t("p",[s._v("1、为什么不用configure，请看下图。haproxy-1.5.14已经存在Makefile文件了。")]),s._v(" "),t("p",[s._v("2、make的时候，target以及arch需要根据自己的linux主机设置")]),s._v(" "),t("p",[s._v("3、make install的时候我增加了一些额外选项。这可加可不加由自己配置，不加的话将会按默认路径安装，请看下图。")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413220137111-563982290.jpg"),alt:"wxmp"}}),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413220148908-1689530172.jpg"),alt:"wxmp"}}),s._v(" "),t("h3",{attrs:{id:"_2-、提供启动脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-、提供启动脚本"}},[s._v("#")]),s._v(" 2）、提供启动脚本")]),s._v(" "),t("p",[s._v("将haproxy这个启动脚本放在/etc/init.d/文件夹下，以便我们可以直接service启动它")]),s._v(" "),t("p",[s._v("【注意】：此启动脚本仅仅适合我以上的安装路径。假若安装路径不同，则需要进行相应的修改方可使用。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# haproxy")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chkconfig:   - 85 15")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# description:  HAProxy is a free, very fast and reliable solution \\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#               offering high availability, load balancing, and \\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#               proxying for TCP and  HTTP-based applications")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# processname: haproxy")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# config:      /etc/haproxy/haproxy.cfg")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pidfile:     /var/run/haproxy.pid")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Source function library.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" /etc/rc.d/init.d/functions\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Source networking configuration.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" /etc/sysconfig/network\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Check that networking is up.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NETWORKING")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"no"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/sbin/haproxy"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("prog")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("basename")]),s._v(" $exec"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" -e /etc/sysconfig/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" /etc/sysconfig/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cfgfile")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/haproxy/haproxy.cfg\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pidfile")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/run/haproxy.pid\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("lockfile")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lock/subsys/haproxy\n\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("check")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exec")]),s._v(" -c -V -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cfgfile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OPTIONS")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("start")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exec")]),s._v(" -c -q -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cfgfile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OPTIONS")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v(" -ne "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Errors in configuration file, check with '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v(' check."')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -n $"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Starting '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v(': "')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# start it up here, usually something like "daemon $exec"')]),s._v("\n    daemon "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exec")]),s._v(" -D -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cfgfile")]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pidfile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OPTIONS")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("retval")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$retval")]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$lockfile")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$retval")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("stop")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -n $"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Stopping '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v(': "')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# stop it here, often "killproc $prog"')]),s._v("\n    killproc "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("retval")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$retval")]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$lockfile")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$retval")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exec")]),s._v(" -c -q -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cfgfile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OPTIONS")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v(" -ne "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Errors in configuration file, check with '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v(' check."')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n    stop\n    start\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("reload")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exec")]),s._v(" -c -q -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cfgfile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OPTIONS")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v(" -ne "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Errors in configuration file, check with '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v(' check."')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -n $"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Reloading '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v(': "')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$exec")]),s._v(" -D -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cfgfile")]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pidfile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OPTIONS")]),s._v(" -sf "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" $pidfile"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("retval")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$retval")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("force_reload")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    restart\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("fdr_status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    status "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prog")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("\n    start"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("stop"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("restart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("reload"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    force-reload"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        force_reload\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    check"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        check\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        fdr_status\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    condrestart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("try-restart"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$lockfile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" restart\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    *"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Usage: '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$0")]),s._v(' {start|stop|status|restart|try-restart|reload|force-reload}"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("esac")]),s._v("\n")])])]),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#给执行权力")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#chmod +x /etc/init.d/haproxy ")]),s._v("\n")])])]),t("h3",{attrs:{id:"_3-、提供配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-、提供配置文件"}},[s._v("#")]),s._v(" 3）、提供配置文件")]),s._v(" "),t("p",[s._v("根据上面的启动脚本建立相应的目录以及配置文件")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /etc/haproxy")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /var/lib/haproxy")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# useradd -r haproxy       #建立脚本启动用户")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/haproxy/haproxy.cfg")]),s._v("\n")])])]),t("p",[s._v("【配置文件】")]),s._v(" "),t("p",[s._v("#这里的配置文件仅仅只是贴出来进行解析说明。")]),s._v(" "),t("p",[s._v("#如果需要这个配置文件最好将注释解析全部删除掉，因为我在使用的过程中，正是因为存在注释解析而导致出错，删除后就能正常运行。")]),s._v(" "),t("p",[s._v("#可以下载这个配置文件进行使用，与下面贴出来的配置文件一致，只是不存在注释解析")]),s._v(" "),t("p",[s._v("#百度云下载该配置文件（不含注释）：链接：http://pan.baidu.com/s/1gfOMtKB 密码：zl9o")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("global\n\n    log         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 local2         //日志定义级别\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v("      /var/lib/haproxy         //当前工作目录\n    pidfile     /var/run/haproxy.pid     //进程id\n    maxconn     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4000")]),s._v("                     //最大连接数\n    user        haproxy                  //运行改程序的用户\n    group       haproxy\n    daemon                               //后台形式运行\n    stats socket /var/lib/haproxy/stats\n\ndefaults\n    mode                    tcp            //haproxy运行模式（http "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" tcp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" health）\n    log                     global\n    option                  dontlognull\n    option                  redispatch     //serverId对应的服务器挂掉后,强制定向到其他健康的服务器\n    retries                 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("              //三次连接失败则服务器不用\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" http-request    10s\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" queue           1m\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" connect         10s            //连接超时\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" client          1m             //客户端超时\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" server          1m             //服务器超时\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" http-keep-alive 10s\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" check           10s            //心跳检测\n    maxconn                 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v("            //最大连接数\n\nlisten stats                               //配置haproxy状态页（用来查看的页面）\n    mode http\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" :8888\n    stats "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v("\n    stats hide-version                    //隐藏haproxy版本号\nstats uri     /haproxyadmin?stats     //一会用于打开状态页的uri\n    stats realm   Haproxy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" Statistics     //输入账户密码时的提示文字\n    stats auth    admin:admin             //用户名:密码\n\nfrontend  main \n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:3306                     //使用3306端口。监听前端端口【表示任何ip访问3306端口都会将数据轮番转发到mysql服务器群组中】\n    default_backend             mysql     //后端服务器组名\n\nbackend mysql\n    balance     leastconn                 //使用最少连接方式调度\n    server mysql1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".95.11:3306 check port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v(" maxconn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n    server mysql2 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".95.12:3306 check port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v(" maxconn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n")])])]),t("h3",{attrs:{id:"_4-、启动日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-、启动日志"}},[s._v("#")]),s._v(" 4）、启动日志")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/rsyslog.conf ")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413220722689-1937574322.jpg"),alt:"wxmp"}}),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("#service rsyslog restart\n")])])]),t("h3",{attrs:{id:"_5-、启动haproxy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-、启动haproxy"}},[s._v("#")]),s._v(" 5）、启动haproxy")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service haproxy start")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413220823642-231712137.jpg"),alt:"wxmp"}}),s._v(" "),t("h3",{attrs:{id:"_6-、测试haproxy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-、测试haproxy"}},[s._v("#")]),s._v(" 6）、测试haproxy")]),s._v(" "),t("p",[s._v("安照配置文件进行相应的测试")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413220910892-1280465641.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("打开浏览器输入192.168.95.13:8888/haproxyadmin?stats")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413220924845-1167063848.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("登陆后如下如所示，表明安装haproxy成功。")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413220939720-768985685.jpg"),alt:"wxmp"}}),s._v(" "),t("h3",{attrs:{id:"_5-2、安装keepalived"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2、安装keepalived"}},[s._v("#")]),s._v(" 5.2、安装keepalived")]),s._v(" "),t("p",[s._v("官网下载：http://www.keepalived.org/download.html")]),s._v(" "),t("p",[s._v("在192.168.95.13、192.168.95.14安装keepalived")]),s._v(" "),t("h3",{attrs:{id:"_1-、解决缺少的软件库文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-、解决缺少的软件库文件"}},[s._v("#")]),s._v(" 1）、解决缺少的软件库文件")]),s._v(" "),t("p",[s._v("【这一步骤视具体的linux版本而定，有些已经安装openssl了。具体情况可以执行./configure就能够确定缺不缺少软件库文件了】")]),s._v(" "),t("p",[s._v("首先我们先将keepalived-1.2.19.tar.gz解压，然后进入目录./configure查看")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar -zxvf keepalived-1.2.19.tar.gz")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./configure --prefix=/usr/local/keepalived  --sbindir=/usr/sbin/ --sysconfdir=/etc/ --mandir=/usr/local/share/man/ --with-kernel-dir=/usr/src/kernels/2.6.32-504.el6.x86_64/")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413221140533-188004616.jpg"),alt:"wxmp"}}),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170413221146455-416499155.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("由上图可见keepalived的安装需要先安装软件OpenSSL")]),s._v(" "),t("p",[s._v("缺少头文件，只需要安装openssl和openssl-devel即可")]),s._v(" "),t("p",[s._v("最简单的方法是：yum -y install openssl openssl-devel")]),s._v(" "),t("p",[s._v("没网的朋友也不用怕，接下来将介绍的是"),t("strong",[s._v("rpm方法安装：")])]),s._v(" "),t("p",[s._v("#挂载光盘，在光盘中查找软件。若光盘找不到就直接下载，再传入linux进行安装")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount /dev/cdrom  /home/suifeng2/rom/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd rom/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd Packages/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls |grep openssl")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081004298-1312936056.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("安装keepalived软件时存在各种依赖，下图是我安装软件后整理的依赖关系图：")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081041126-412729314.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("既然已经知道各软件依赖，则可按最后面的软件开始安装：")]),s._v(" "),t("p",[s._v("（你也可以从前面开始进行安装，一步一步的查看各个依赖关系）")]),s._v(" "),t("p",[t("strong",[s._v("1")]),s._v("**、安装openssl**")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh openssl-1.0.1e-30.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081122533-1090149961.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("安装openssl成功")]),s._v(" "),t("p",[t("strong",[s._v("2")]),s._v("**、安装openssl-devel****\n**")]),s._v(" "),t("p",[s._v("*"),t("strong",[s._v("安装libsepol-devel：*")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh libsepol-devel-2.0.41-4.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081203986-1033904545.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("*"),t("strong",[s._v("安装pkgconfig(libsepol)：*")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh pkgconfig-0.23-9.1.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081326048-108728484.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("*"),t("strong",[s._v("安装libselinux-devel：*")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh libselinux-devel-2.0.94-5.8.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081354861-1151114167.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[t("em",[t("strong",[s._v("安装keyutils-libs-devel：")])])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh keyutils-libs-devel-1.4-5.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081423955-808450124.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("安装libcom_err-devel：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh libcom_err-devel-141.12-21.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081449345-1582885369.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[t("em",[t("strong",[s._v("安装krb5-devel：")])])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh krb5-devel-1.10.3-33.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081613798-100750928.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[t("em",[t("strong",[s._v("安装zlib-devel：")])])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh zlib-devel-1.2.3-29.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081638705-1501389033.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[t("strong",[s._v("安装openssl-devel")]),s._v("**：**")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh openssl-devel-1.0.1e-30.el6.x86_64.rpm")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081706642-834222715.jpg"),alt:"wxmp"}}),s._v(" "),t("h3",{attrs:{id:"_2-、编译安装keepalived软件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-、编译安装keepalived软件"}},[s._v("#")]),s._v(" 2）、编译安装keepalived软件")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd keepalived-1.2.19")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./configure --prefix=/usr/local/keepalived  --sbindir=/usr/sbin/ --sysconfdir=/etc/ --mandir=/usr/local/share/man/ --with-kernel-dir=/usr/src/kernels/2.6.32-504.el6.x86_64/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make && make install")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chkconfig --add keepalived  #添加开机自启（我暂时没添加）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chkconfig keepalived on")]),s._v("\n")])])]),t("p",[s._v("【注意】：")]),s._v(" "),t("p",[s._v("1、安装时./configure中的—prefix后的几个选择可选可不选，选了就可以采用service直接启动了。建议最好都加上吧")]),s._v(" "),t("p",[s._v("2、--with-kernel-dir这个选项根据自己的linux版本进行填写（在linux中使用命令uname –a可以查到）")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081810158-920097908.jpg"),alt:"wxmp"}}),s._v(" "),t("h3",{attrs:{id:"_3-、创建配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-、创建配置文件"}},[s._v("#")]),s._v(" 3）、创建配置文件")]),s._v(" "),t("p",[s._v("/etc/keepalived/文件夹已存在keepalived.conf文件，我们将它改名为keepalived.conf.back，再建立一个我们自己keepalived.conf配置文件。")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414081912595-1589363918.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("vi /etc/keepalived/keepalived.conf（13与14配置文件路径一致）")]),s._v(" "),t("p",[s._v("【以下是简单的配置文件，使用时最好去掉注释】")]),s._v(" "),t("p",[s._v("配置文件下载（不含注释）：")]),s._v(" "),t("p",[t("em",[t("strong",[s._v("192.168.95.13配置文件:")])])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Configuration File "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" keepalived\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#简单的头部，这里主要可以做邮件通知报警等的设置，此处就暂不配置了；")]),s._v("\nglobal_defs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        notificationd LVS_DEVEL\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#预先定义一个脚本，方便后面调用，也可以定义多个，方便选择；")]),s._v("\nvrrp_script chk_haproxy "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    script "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/keepalived/chk.sh"')]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#具体脚本路径")]),s._v("\n    interval "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#脚本循环运行间隔")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#VRRP虚拟路由冗余协议配置")]),s._v("\nvrrp_instance VI_1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#VI_1 是自定义的名称；")]),s._v("\n    state BACKUP    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#MASTER表示是一台主设备，BACKUP表示为备用设备【我们这里因为设置为开启不抢占，所以都设置为备用】")]),s._v("\n    nopreempt      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启不抢占")]),s._v("\n    interface eth0   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定VIP需要绑定的物理网卡")]),s._v("\n    virtual_router_id "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#VRID虚拟路由标识，也叫做分组名称，该组内的设备需要相同")]),s._v("\n    priority "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("130")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#定义这台设备的优先级 1-254；开启了不抢占，所以此处优先级必须高于另一台")]),s._v("\n\n    advert_int "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#生存检测时的组播信息发送间隔，组内一致")]),s._v("\n    authentication "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置验证信息，组内一致")]),s._v("\n        auth_type PASS   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#有PASS 和 AH 两种，常用 PASS")]),s._v("\n        auth_pass asd    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#密码")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    virtual_ipaddress "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".95.55    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定VIP地址，组内一致，可以设置多个IP")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    track_script "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#使用在这个域中使用预先定义的脚本，上面定义的")]),s._v("\n        chk_haproxy   \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    notify_backup "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/init.d/haproxy restart"')]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#表示当切换到backup状态时,要执行的脚本")]),s._v("\n    notify_fault "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/init.d/haproxy stop"')]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#故障时执行的脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[t("em",[t("strong",[s._v("192.168.95.14配置文件:")])])]),s._v(" "),t("p",[s._v("配置文件与上面的几乎一样，仅仅改变priority 120【只需要比上面的小即可】")]),s._v(" "),t("h3",{attrs:{id:"_4-、创建脚本文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-、创建脚本文件"}},[s._v("#")]),s._v(" 4）、创建脚本文件")]),s._v(" "),t("p",[s._v("创建上面配置文件所需的脚本文件（13、14一样）")]),s._v(" "),t("p",[s._v("（检测haproxy有没有发生故障，发生故障则将keepalived停掉，让出vip）")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/keepalived/chk.sh#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -C haproxy --no-header "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n       /etc/init.d/keepalived stop\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n给执行权限\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod +x /etc/keepalived/chk.sh")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082223158-2122872733.jpg"),alt:"wxmp"}}),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("启动keepalived：\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service keepalived start")]),s._v("\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082247861-1856007348.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("安装keepalived成功！")]),s._v(" "),t("h2",{attrs:{id:"_6、功能测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6、功能测试"}},[s._v("#")]),s._v(" 6、功能测试")]),s._v(" "),t("p",[s._v("测试之前先在mysql1和mysql2中建立一个mysql用户，此用户可以允许13、14linux主机登陆：")]),s._v(" "),t("p",[s._v("用户：jack")]),s._v(" "),t("p",[s._v("密码：321")]),s._v(" "),t("p",[s._v("host：192.168.95.%")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'jack'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'192.168.95.%'")]),s._v(" IDENTIFIED "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'321'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" FLUSH "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h3",{attrs:{id:"_6-1、流程简述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1、流程简述"}},[s._v("#")]),s._v(" 6.1、流程简述")]),s._v(" "),t("p",[s._v("大概讲述一下整体的运作流程:")]),s._v(" "),t("p",[s._v("首先两个11,12的mysql以及13、14的haproxy、keepalived都启动；")]),s._v(" "),t("p",[s._v("keepalived在keepalived群组中获取虚拟IP，以及检测haproxy是否被kill；")]),s._v(" "),t("p",[s._v("haproxy负责将进来的数据转发到11或者12的mysql中。")]),s._v(" "),t("p",[s._v("下图是我画的简单理解图：（相对来说比较简洁哈，凑合凑合哈）")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082417220-1947348099.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("接下来我们将一个个功能的进行测试验证。")]),s._v(" "),t("h3",{attrs:{id:"_6-2、测试haproxy监听前端端口3306"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-2、测试haproxy监听前端端口3306"}},[s._v("#")]),s._v(" 6.2、测试haproxy监听前端端口3306")]),s._v(" "),t("p",[s._v("1、frontend监听端口3306时，将mysql、haproxy、keepalived全部开启")]),s._v(" "),t("p",[s._v("2、使用任意一个mysql客户端登陆用户jack")]),s._v(" "),t("p",[s._v("登陆成功(windowns上登陆mysql)")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082454267-647656487.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("3、更改frontend监听端口为3307，继续操作登陆测试")]),s._v(" "),t("p",[s._v("登陆失败")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082555158-489818325.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("结果：说明了frontend监听端口的用处，有助于我们理解haproxy用法。")]),s._v(" "),t("h3",{attrs:{id:"_6-3、测试高可用-keepalived不抢占vip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-3、测试高可用-keepalived不抢占vip"}},[s._v("#")]),s._v(" 6.3、测试高可用+keepalived不抢占vip")]),s._v(" "),t("p",[s._v("可以通过haproxy监控页面获知谁获取了vip")]),s._v(" "),t("p",[s._v("1、依次启动13、14的keepalived、haproxy（启动keepalived后将会自动开启haproxy）")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082633189-1711212150.jpg"),alt:"wxmp"}}),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082639205-259704877.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("2、访问http://192.168.95.55:8888/haproxyadmin?stats")]),s._v(" "),t("p",[s._v("13获取了vip")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082710986-1511278821.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("3、# kill -9 8923")]),s._v(" "),t("p",[s._v("刷新http://192.168.95.55:8888/haproxyadmin?stats")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082730501-587455310.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("14获取了vip，机器正常工作")]),s._v(" "),t("p",[s._v("结果：证明了高可用，挂了一台另一台继续工作")]),s._v(" "),t("p",[s._v("4、重新启动13的haproxy以及keepalived")]),s._v(" "),t("p",[s._v("并刷新http://192.168.95.55:8888/haproxyadmin?stats")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082824517-1843082583.jpg"),alt:"wxmp"}}),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082838033-1048193667.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("结果：此时vip仍在14手中，证明了keepalived配置了不抢占vip，不必浪费资源去获取vip。")]),s._v(" "),t("h3",{attrs:{id:"_6-4、测试负载均衡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4、测试负载均衡"}},[s._v("#")]),s._v(" 6.4、测试负载均衡")]),s._v(" "),t("p",[s._v("1、全部正常启动，此时vip在14手中")]),s._v(" "),t("p",[s._v("2、分别在11、12中开启抓包")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcpdump -n -i eth0 host 192.168.95.11 and 192.168.95.14")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcpdump -n -i eth0 host 192.168.95.12 and 192.168.95.14")]),s._v("\n")])])]),t("p",[s._v("3、使用不同客户端登陆jack用户，不断向数据库添加数据")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082922611-1476794934.jpg"),alt:"wxmp"}}),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414082929673-1795226870.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("结果：此时14向11、12都有发送数据，此时证明负载均衡")]),s._v(" "),t("p",[s._v("【我们设置的haproxy中balance方式是最少连接方式，假若采用roundrobin方式测试结果将会更加明显】")]),s._v(" "),t("p",[s._v("注意：")]),s._v(" "),t("p",[s._v("当某一台mysql挂了以后，haproxy会将其踢出mysql服务器群组。")]),s._v(" "),t("p",[s._v("当有命令传来时会将其转发到正常的服务器上。")]),s._v(" "),t("p",[s._v("当出问题的mysql恢复后，haproxy又会自动地将它放回mysql服务器群组中，并且自动同步没有同步的数据")]),s._v(" "),t("p",[s._v("测试：")]),s._v(" "),t("p",[s._v("1、全部正常启动")]),s._v(" "),t("p",[s._v("mysql1、mysql2都正常")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414084747783-1624501048.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("2、将mysql2关掉")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414084333111-1560178189.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("mysql2出问题，将其踢出mysql群组")]),s._v(" "),t("p",[s._v("3、启动mysql2")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/db/mysqlopt2/mastercase/789055-20170414084635673-770786182.jpg"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("mysql2恢复后又将其放回mysql群组里")]),s._v(" "),t("p",[s._v("【当mysql2挂掉时，若有数据插入，将会转发给mysql1，当mysql恢复后，又会将这些数据同步到mysql2中】")]),s._v(" "),t("h2",{attrs:{id:"_7、总结与建议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7、总结与建议"}},[s._v("#")]),s._v(" 7、总结与建议")]),s._v(" "),t("p",[s._v("在这篇博文中我们不仅仅只关注这一整个mysql高可用负载均衡的实现方式，我们还应该理解haproxy以及keepalived的工作方式。Haproxy和keepalived这两个工具很强大，了解他们的实现方式，那么就可以以此类推与其他服务器组合构建强大健壮的服务集群。例如它可以与apache组合，构成高可用负载均衡的web集群。")]),s._v(" "),t("p",[s._v("这篇文章中只是简简单单的搭建了一个mysql高可用负载均衡的环境，真正应用到生产环境中，还需要根据具体项目进行相应的修改。")]),s._v(" "),t("p",[s._v("最后我的小建议就是看完这篇博客可以去了解了解更多的haproxy和keepalived的相应配置，以及学习与haproxy功能差不多的LVS。")]),s._v(" "),t("p",[s._v("（以上是自己的一些见解与总结，若有不足或者错误的地方请各位指出）")]),s._v(" "),t("p",[s._v("作者："),t("a",{attrs:{href:"http://www.cnblogs.com/phpstudy2015-6/",target:"_blank",rel:"noopener noreferrer"}},[s._v("那一叶随风"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("声明：以上只代表本人在工作学习中某一时间内总结的观点或结论。转载时请在文章页面明显位置给出原文链接")]),s._v(" "),t("h2",{attrs:{id:"参考文章"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),t("ul",[t("li",[s._v("https://www.cnblogs.com/phpstudy2015-6/p/6706465.html")])])])}),[],!1,null,null,null);a.default=r.exports}}]);