(window.webpackJsonp=window.webpackJsonp||[]).push([[679],{1195:function(s,t,a){"use strict";a.r(t);var r=a(53),e=Object(r.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("本文主要是介绍 备份与恢复-基础知识 。")])]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#mysql备份和恢复"}},[s._v("mysql备份和恢复")])]),a("li",[a("a",{attrs:{href:"#一、备份与恢复的概述"}},[s._v("一、备份与恢复的概述")])]),a("li",[a("a",{attrs:{href:"#二、冷备"}},[s._v("二、冷备")])]),a("li",[a("a",{attrs:{href:"#三、逻辑备份"}},[s._v("三、逻辑备份")]),a("ul",[a("li",[a("a",{attrs:{href:"#_3-1、mysqldump"}},[s._v("3.1、mysqldump")])]),a("li",[a("a",{attrs:{href:"#语法"}},[s._v("语法：")])]),a("li",[a("a",{attrs:{href:"#简单使用-由于比较简单-不具体阐述"}},[s._v("简单使用（由于比较简单，不具体阐述）：")])]),a("li",[a("a",{attrs:{href:"#mysqldump工具使用建议"}},[s._v("mysqldump工具使用建议：")])]),a("li",[a("a",{attrs:{href:"#msyqldump结合binlog日志实现增量备份"}},[s._v("msyqldump结合binlog日志实现增量备份")])]),a("li",[a("a",{attrs:{href:"#总结"}},[s._v("总结")])]),a("li",[a("a",{attrs:{href:"#_3-2、select-into-outfile"}},[s._v("3.2、select ... into outfile")])]),a("li",[a("a",{attrs:{href:"#_3-3、逻辑备份的恢复"}},[s._v("3.3、逻辑备份的恢复")])]),a("li",[a("a",{attrs:{href:"#_3-4、load-data-infile"}},[s._v("3.4、load data infile")])]),a("li",[a("a",{attrs:{href:"#_3-5、mysqldump导出"}},[s._v("3.5、mysqldump导出")])]),a("li",[a("a",{attrs:{href:"#_3-6、mysqlimport导入"}},[s._v("3.6、mysqlimport导入")])])])]),a("li",[a("a",{attrs:{href:"#四、热备"}},[s._v("四、热备")]),a("ul",[a("li",[a("a",{attrs:{href:"#_4-1、xtrabackup安装"}},[s._v("4.1、xtrabackup安装")])]),a("li",[a("a",{attrs:{href:"#_4-2、xtrabackup备份原理"}},[s._v("4.2、xtrabackup备份原理")])]),a("li",[a("a",{attrs:{href:"#_4-2-1、备份过程-backup阶段"}},[s._v("4.2.1、备份过程(backup阶段)")])]),a("li",[a("a",{attrs:{href:"#第一种情况-支持"}},[s._v("第一种情况（支持）：")])]),a("li",[a("a",{attrs:{href:"#第二种情况-不支持"}},[s._v("第二种情况（不支持）：")])]),a("li",[a("a",{attrs:{href:"#_4-2-2、准备过程-prepare阶段"}},[s._v("4.2.2、准备过程(prepare阶段)")])]),a("li",[a("a",{attrs:{href:"#_4-2-3、恢复过程-copy-back阶段"}},[s._v("4.2.3、恢复过程(copy back阶段)")])]),a("li",[a("a",{attrs:{href:"#_4-3、innobackupex工具"}},[s._v("4.3、innobackupex工具")])]),a("li",[a("a",{attrs:{href:"#_4-3-1、全备和恢复"}},[s._v("4.3.1、全备和恢复")])]),a("li",[a("a",{attrs:{href:"#_4-3-2、增备和恢复"}},[s._v("4.3.2、增备和恢复")])]),a("li",[a("a",{attrs:{href:"#_4-3-4、部分备份和恢复"}},[s._v("4.3.4、部分备份和恢复")])]),a("li",[a("a",{attrs:{href:"#_4-4、xtrabackup工具"}},[s._v("4.4、xtrabackup工具")])]),a("li",[a("a",{attrs:{href:"#_4-4-1、全备和恢复"}},[s._v("4.4.1、全备和恢复")])]),a("li",[a("a",{attrs:{href:"#_4-4-2、增备和恢复"}},[s._v("4.4.2、增备和恢复")])]),a("li",[a("a",{attrs:{href:"#其他mysql文章请看-mysql学习系列-https-www-cnblogs-com-zsql-p-11493186-html"}},[s._v("其他mysql文章请看：MYSQL学习系列")])]),a("li",[a("a",{attrs:{href:"#参考"}},[s._v("参考：")])])])]),a("li",[a("a",{attrs:{href:"#参考文章"}},[s._v("参考文章")])])])]),a("p"),s._v(" "),a("h2",{attrs:{id:"mysql备份和恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql备份和恢复"}},[s._v("#")]),s._v(" mysql备份和恢复")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("对于DBA来说，数据的备份和恢复是一项很基本的操作。在意外的情况下（服务器宕机，磁盘损坏，RAID卡损坏等），要保证数据不丢失，或者是最小程度的丢失，是每个DBA每时每刻应该关心数据库的备份了。本来说明下备份的工具，原理以及使用。\n")])])]),a("h2",{attrs:{id:"一、备份与恢复的概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、备份与恢复的概述"}},[s._v("#")]),s._v(" 一、备份与恢复的概述")]),s._v(" "),a("p",[s._v("按照是否能够继续提供服务，将数据库备份类型划分为：")]),s._v(" "),a("ul",[a("li",[s._v("热备份：（在线备份）在数据库运行的过程中进行备份，并且不影响数据库的任何操作")]),s._v(" "),a("li",[s._v("温备份：能读不能写，在数据运行的过程中进行备份，但是对数据有影响，如需要加全局锁保证数据的一致性。")]),s._v(" "),a("li",[s._v("冷备份：（离线备份）在停止数据库的情况下，复制备份数据库的物理文件。")])]),s._v(" "),a("p",[s._v("按照备份后文件的内容分类：")]),s._v(" "),a("ul",[a("li",[s._v("逻辑备份：备份文件时可读的文本文件，比如sql语句，适合数据库的迁移和升级，但是恢复时间比较长。")]),s._v(" "),a("li",[s._v("裸文件备份：复制数据库的物理文件")])]),s._v(" "),a("p",[s._v("按照备份数据库的内容分类：")]),s._v(" "),a("ul",[a("li",[s._v("完全备份：对数据库进行一个完整的备份\n增量备份：在完全备份的基础上，对数据库的增量进行备份")]),s._v(" "),a("li",[s._v("日志备份：只要是对binlog的备份")])]),s._v(" "),a("h2",{attrs:{id:"二、冷备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、冷备"}},[s._v("#")]),s._v(" 二、冷备")]),s._v(" "),a("p",[s._v("只需要备份mysql数据库的frm文件，共享表空间文件，独立表空间文件(*.ibd)，重做日志文件，以及msyql的配置文件my.cnf。")]),s._v(" "),a("p",[s._v("优点：")]),s._v(" "),a("ul",[a("li",[s._v("备份简单，只需要复制文件就可以")]),s._v(" "),a("li",[s._v("恢复简单，只需要把文件恢复到指定位置")]),s._v(" "),a("li",[s._v("恢复速度快，")])]),s._v(" "),a("p",[s._v("缺点：")]),s._v(" "),a("ul",[a("li",[s._v("备份文件较大，因为表空间存在大量的其他数据，比如undo段，插入缓冲等")]),s._v(" "),a("li",[s._v("不能总是轻易跨平台")])]),s._v(" "),a("h2",{attrs:{id:"三、逻辑备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、逻辑备份"}},[s._v("#")]),s._v(" 三、逻辑备份")]),s._v(" "),a("h3",{attrs:{id:"_3-1、mysqldump"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1、mysqldump"}},[s._v("#")]),s._v(" 3.1、mysqldump")]),s._v(" "),a("h3",{attrs:{id:"语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#语法"}},[s._v("#")]),s._v(" 语法：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mysqldump "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OPTIONS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmysqldump "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OPTIONS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--databases [OPTIONS] DB1 [DB2 DB3...]")]),s._v("\nmysqldump "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OPTIONS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--all-databases [OPTIONS]")]),s._v("\n")])])]),a("p",[s._v("选项：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("u"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--user=name        #指定用户名")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--socket=name      #指定套接字路径")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--password[=name]  #指定密码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("P"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--port=3306        #指定端口")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("h"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--host=name        #指定主机名")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--result-file=name #将导出结果保存到指定的文件中，在Linux中等同于覆盖重定向。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--all-databases, -A    #指定dump所有数据库。等价于使用--databases选定所有库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--databases, -B        #指定需要dump的库。该选项后的所有内容都被当成数据库名；在输出文件中的每个数据库前会加上建库语句和use语句")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--ignore-table=db_name.tbl_name   #导出时忽略指定数据库中的指定表，同样可用于忽略视图，要忽略多个则多次写该选项")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--no-data          #不导出表数据，可以用在仅导出表结构的情况。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--events, -E           #导出事件调度器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--routines, -R         #导出存储过程和函数。但不会导出它们的属性值，若要导出它们的属性，可以导出mysql.proc表然后reload")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--triggers             #导出触发器，默认已开启")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--tables               #覆盖--databases选项，导出指定的表。但这样只能导出一个库中的表。格式为--tables database_name tab_list")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--where='where_condition', -w 'where_condition'   #指定筛选条件并导出表中符合筛选的数据，如--where=\"user='jim'\"")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--add-drop-database    #在输出中的create database语句前加上drop database语句先删除数据库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--add-drop-table       #在输出的create table语句前加上drop table语句先删除表，默认是已开启的")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--add-drop-trigger     #在输出中的create trigger语句前加上drop trigger语句先删除触发器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--no-create-db     #指定了--databases或者--all-databases选项时默认会加上数据库创建语句，该选项抑制建库语句的输出")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--no-create-info   #不在输出中包含建表语句")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--replace              #使用replace代替insert语句")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--default-character-set=charset_name  #在导出数据的过程中，指定导出的字符集。很重要，客户端服务端字符集不同导出时可能乱码，默认使用utf8")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--set-charset          #在导出结果中加上set names charset_name语句。默认启用。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--compact              #简化输出导出的内容，几乎所有注释都不会输出")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--complete-insert, -c  #在insert语句中加上插入的列信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--create-options       #在导出的建表语句中，加上所有的建表选项")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--tab=dir_name, -T dir_name #将每个表的结构定义和数据分别导出到指定目录下文件名同表名的.sql和txt文件中，其中.txt")]),s._v("\n                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#文件中的字段分隔符是制表符。要求mysqldump必须和MySQL Server在同一主机，且mysql用")]),s._v("\n                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#户对指定的目录有写权限，并且连接数据库的用户必须有file权限。且指定要dump的表，不能和")]),s._v("\n                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#--databases或--all-databases一起使用。它的实质是执行select into outfile。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--fields-terminated-by=name #指定输出文件中的字段分隔符")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--fields-enclosed-by=name   #指定输出文件中的字段值的包围符，如使用引号将字符串包围起来引用")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--fields-optionally-enclosed-by=name   #指定输出文件中可选字段引用符")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--fields-escaped-by=name               #指定输出文件中的转义符")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--lines-terminated-by=name             #指定输出文件中的换行符   ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Q"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('--quote-names                      #引用表名和列名时使用的标识符，默认使用反引号"`" ')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--delayed-insert         #对于非事务表，在insert时支持delayed功能，但在MySQL5.6.6开始该选项已经废弃")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--disable-keys, -K       #在insert语句前后加上禁用和启用索引语句，大量数据插入时该选项很适合。默认开启")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--insert-ignore          #使用insert ignore语句替代insert语句")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--quick, -q              #快速导出数据，该选项对于导出大表非常好用。默认导出数据时会一次性检索表中所有数据并加入")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#到内存中，而该选项是每次检索一行并导出一行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--add-locks              #在insert语句前后加上lock tables和unlock tables语句，默认已开启。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--flush-logs, -F         #在开始dump前先flush logs，如果同时使用了--all-databases则依次在每个数据库dump前flush，")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果同时使用了--lock-all-tables,--master-data或者--single-transaction，则仅flush")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#一次，等价于使用flush tables with read lock锁定所有表，这样可以让dump和flush在完全精")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#确的同一时刻执行。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--flush-privileges       #在dump完所有数据库后在数据文件的结尾加上flush privileges语句，在导出的数据涉及mysql库或")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#者依赖于mysql库时都应该使用该选项")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--lock-all-tables, -x    #为所有表加上一个持续到dump结束的全局读锁。该选项在dump阶段仅加一次锁，一锁锁永久且锁所有。")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#该选项自动禁用--lock-tables和--single-transaction选项")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--lock-tables, -l        #在dump每个数据库前依次对该数据库中所有表加read local锁(多次加锁，lock tables...read local)，")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这样就允许对myisam表进行并发插入。对于innodb存储引擎，使用--single-transaction比")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--lock-tables            #更好，因为它不完全锁定表。因为该选项是分别对数据库加锁的，所以只能保证每个数")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#据库的一致性而不能保证所有数据库之间的一致性。该选项主要用于myisam表，如果既有myisam又有")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#innodb，则只能使用--lock-tables，或者分开dump更好")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--single-transaction     #该选项在dump前将设置事务隔离级别为repeatable read并发送一个start transaction语句给")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#服务端。该选项对于导出事务表如innodb表很有用，因为它在发出start transaction后能保证导")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#出的数据库的一致性时而不阻塞任何的程序。该选项只能保证innodb表的一致性，无法保证myisam表")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#的一致性。在使用该选项的时候，一定要保证没有任何其他连接在使用ALTER TABLE,CREATE TABLE,")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#DROP TABLE,RENAME TABLE,TRUNCATE TABLE语句，因为一致性读无法隔离这些语句。")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#--single-transaction 选项和--lock-tables选项互斥，因为lock tables会隐式提交事务。")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#要导出大的innodb表，该选项结合--quick选项更好")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--no-autocommit          #在insert语句前后加上SET autocommit = 0，并在需要提交的地方加上COMMIT语句")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--order-by-primary       #如果表中存在主键或者唯一索引，则排序后按序导出。对于myisam表迁移到innobd表时比较有用，但是")]),s._v("\n                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这样会让事务变得很长很慢    ")]),s._v("\n")])])]),a("h3",{attrs:{id:"简单使用-由于比较简单-不具体阐述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单使用-由于比较简单-不具体阐述"}},[s._v("#")]),s._v(" 简单使用（由于比较简单，不具体阐述）：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mysqldump "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("r "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份所有数据库")]),s._v("\nmysqldump "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份所有数据库        ")]),s._v("\nmysqldump "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("B test test1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db_test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份test和test1数据库")]),s._v("\nmysqldump "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--single-transaction -A > all.sql #innodb开始事务备份所有数据 ")]),s._v("\nmysqldump "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--default-character-set=latin1 -A > all.sql #指定字符集备份所有数据")]),s._v("\nmysqldump "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--tables test gxt1 -r gxt.sql  #备份test库的gxt1表")]),s._v("\n")])])]),a("h3",{attrs:{id:"mysqldump工具使用建议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysqldump工具使用建议"}},[s._v("#")]),s._v(" mysqldump工具使用建议：")]),s._v(" "),a("p",[s._v("1.从性能考虑：在需要导出大量数据的时候，使用--quick选项可以加速导出，但导入速度不变。如果是innodb表，则可以同时加上--no-autocommit选项，这样大量数据量导入时将极大提升性能。")]),s._v(" "),a("p",[s._v("2.一致性考虑：对于innodb表，几乎没有理由不用--single-transaction选项。对于myisam表，使用--lock-all-tables选项要好于--lock-tables。既有innodb又有myisam表时，可以分开导出，又能保证一致性，还能保证效率。")]),s._v(" "),a("p",[s._v("3.方便管理和维护性考虑：在导出时flush log很有必要。加上--flush-logs选项即可。而且一般要配合--lock-all-tables选项或者--single-transaction选项一起使用，因为同时使用时，只需刷新一次日志即可，并且也能保证一致性。同时，还可以配合--master-data=2，这样就可以方便地知道二进制日志中备份结束点的位置。")]),s._v(" "),a("p",[s._v("4.字符集考虑：如果有表涉及到了中文数据，在dump时，一定要将dump的字符集设置的和该表的字符集一样。")]),s._v(" "),a("p",[s._v("5.杂项考虑：备份过程中会产生二进制日志，但是这是没有必要的。所以在备份前可以关掉，备份完后开启。set sql_log_bin=0关闭，set sql_log_bin=1开启。")]),s._v(" "),a("h3",{attrs:{id:"msyqldump结合binlog日志实现增量备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#msyqldump结合binlog日志实现增量备份"}},[s._v("#")]),s._v(" msyqldump结合binlog日志实现增量备份")]),s._v(" "),a("ul",[a("li",[s._v("1、首先全备：mysqldump -uroot -p123456 -q --no-autocommit --flush-logs --single-transaction --master-data=2 --tables test gxt1 > gxt.sql")]),s._v(" "),a("li",[s._v("2、修改表中的数据：insert into test.gxt1 values(1,'王麻子');")]),s._v(" "),a("li",[s._v("3、备份二进制日志：mysqlbinlog mysql-bin.000002 >new_gxt.sql #这里需要指定时间或者指定position对增量进行备份")]),s._v(" "),a("li",[s._v("4、模拟删掉：drop table test.gxt1;")]),s._v(" "),a("li",[s._v("5、恢复：")])]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("source gxt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("source new_gxt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("h3",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("msyqldump是属于逻辑备份，备份sql语句，简单，但是由于恢复时都是通过insert进行插入，所有恢复速度慢，mysqldump备份myisam表时因为要加--lock-all-tables，这时要备份的数据库全部被上锁，可读不可写，所以实现的是温备。mysqldump备份innodb表时因为要加--single-transaction，会自动将隔离级别设置为repeatable read并开启一个事务，这时mysqldump将获取dump执行前一刻的行版本，并处于一个长事务中直到dump结束。所以不影响目标数据库的使用，可读也可写，即实现的是热备\n")])])]),a("h3",{attrs:{id:"_3-2、select-into-outfile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2、select-into-outfile"}},[s._v("#")]),s._v(" 3.2、select ... into outfile")]),s._v(" "),a("p",[s._v("load data infile和select into outfile语句是配套的。可以通过参数secure_file_priv对其进行控制是否可以使用：")]),s._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190910152306953-771266839.png"),alt:"wxmp"}}),s._v(" "),a("p",[s._v("常用自定义格式说明：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'string'")]),s._v("指定字段分隔符；\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'char'")]),s._v("指定所有字段都使用"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v("符号包围，如果指定了"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("optionally")]),s._v("则只用在字符串和日期数据类型等字段上，默认未指定；\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("escaped")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'char'")]),s._v("指定转义符。\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("starting")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'string'")]),s._v("指定行开始符，如每行开始记录前空一个制表符；\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'string'")]),s._v("为行分隔符。\n默认：\nfileds "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("escaped")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\\'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("starting")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n")])])]),a("p",[s._v("简单使用例子：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" test "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("outfile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/data/t_data.sql'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("outfile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/data/t_data.sql'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" test "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("outfile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/data/t_data.sql'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("outfile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/data/t_data1.sql'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\''")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("starting")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("h3",{attrs:{id:"_3-3、逻辑备份的恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3、逻辑备份的恢复"}},[s._v("#")]),s._v(" 3.3、逻辑备份的恢复")]),s._v(" "),a("p",[s._v("语法很简单：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mysql "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" all_bak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),s._v("\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("source "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("root"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("all_bak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#登录mysql")]),s._v("\n")])])]),a("h3",{attrs:{id:"_3-4、load-data-infile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4、load-data-infile"}},[s._v("#")]),s._v(" 3.4、load data infile")]),s._v(" "),a("p",[s._v("选项同select into outfile是一样的，增加了gnore N lines|rows表示忽略前N行数据不导入，set col_name=expr表示对列进行一些表达式运算")]),s._v(" "),a("p",[s._v("基本使用：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("infile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/data1.sql'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gxt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" （id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name）"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" is_enable"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定字段")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("infile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/data1.sql'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gxt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\''")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("escaped")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\\'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("starting")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("infile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/data1.sql'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gxt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\''")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("escaped")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\\'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("starting")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ignore")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#忽略前两行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("infile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/data1.sql'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gxt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\''")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("escaped")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\\'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("starting")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置列，下同")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("infile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/data1.sql'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gxt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\''")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("escaped")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\\'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("starting")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("concat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@qq.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("infile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/data1.sql'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gxt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\''")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("escaped")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\\'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("starting")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("concat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@qq.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("h3",{attrs:{id:"_3-5、mysqldump导出"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-5、mysqldump导出"}},[s._v("#")]),s._v(" 3.5、mysqldump导出")]),s._v(" "),a("p",[s._v("本质和select into outfile一样")]),s._v(" "),a("p",[s._v('mysql -uroot -p123456 -e "select * from test.gxt" > a.txt #虽然这样也可以导出数据，但是是没有格式的\nmysqldump -uroot -p123456 --tab /data/test test gxt1 #这里指定的目录mysql用户需要有写权限，还需要设定参数secure-file-priv=/data/test')]),s._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190910155741903-1138319364.png"),alt:"wxmp"}}),s._v(" "),a("p",[s._v("如上的导出方式，既有表结构的定义，又有表数据的导出。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v(' mysqldump的"--tab"选项同样可以指定各种分隔符。如"--fields-terminated-by=...,--fields-enclosed-by=...,--fields-optionally-enclosed-by=...,--fields-escaped-by=..."。以下是指定字段分隔符为","\n')])])]),a("h3",{attrs:{id:"_3-6、mysqlimport导入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-6、mysqlimport导入"}},[s._v("#")]),s._v(" 3.6、mysqlimport导入")]),s._v(" "),a("p",[s._v("mysqlimport本质上就是load data infile的命令接口，而且大多数的语法与之相似，不同的是mysqlimport可以同时导入多张表，通过参数--user-thread并发导入不同的文件")]),s._v(" "),a("p",[s._v("简单使用例子：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mysqlimport "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--fields-terminated-by=',' test '/home/t.txt'")]),s._v("\nmysqlimport "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p123456 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--fields-terminated-by=',' --user-thread test '/home/t.txt' 'home/gxt1.txt'  #并发导入两个表")]),s._v("\n")])])]),a("h2",{attrs:{id:"四、热备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、热备"}},[s._v("#")]),s._v(" 四、热备")]),s._v(" "),a("h3",{attrs:{id:"_4-1、xtrabackup安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1、xtrabackup安装"}},[s._v("#")]),s._v(" 4.1、xtrabackup安装")]),s._v(" "),a("p",[s._v("官网地址：https://www.percona.com/downloads/Percona-XtraBackup-LATEST/")]),s._v(" "),a("p",[s._v("1、配置yum源：yum installhttps://repo.percona.com/yum/percona-release-latest.noarch.rpm （推荐）")]),s._v(" "),a("p",[s._v("2、安装：yum install percona-xtrabackup-24")]),s._v(" "),a("p",[s._v("本来装了个最新版yum install percona-xtrabackup-80，但是。。。有点尴尬（版本8.0不支持mysql5.x），新版本已经没有innobackupex这个工具了")]),s._v(" "),a("p",[s._v("安装完成之后会生成如下工具：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ql percona-xtrabackup-24 | grep bin |xargs ls -l")]),s._v("\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" 05:33 /usr/bin/innobackupex -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" xtrabackup\n-rwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3846952")]),s._v(" Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 03:59 /usr/bin/xbcloud\n-rwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3020")]),s._v(" Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 03:53 /usr/bin/xbcloud_osenv\n-rwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3603744")]),s._v(" Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 03:59 /usr/bin/xbcrypt\n-rwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3612192")]),s._v(" Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 03:59 /usr/bin/xbstream\n-rwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21730616")]),s._v(" Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 03:59 /usr/bin/xtrabackup\n\n\n")])])]),a("ul",[a("li",[s._v("xbcloud和xbcloud_osenv是xtrabackup新的高级特性：云备份；")]),s._v(" "),a("li",[s._v("xbcrypt也是新的特性，加密备份集；")]),s._v(" "),a("li",[s._v("xbstream是xtrabackup的流数据功能，通过流数据功能，可将备份内容打包并传给管道后的压缩工具进行压缩；")]),s._v(" "),a("li",[s._v("xtrabackup是主程序")]),s._v(" "),a("li",[s._v("innobackupex在以前是一个perl脚本，会调用xtrabackup这个二进制工具，从xtrabackup 2.3开始，该工具使用C语言进行了重写，当前它是xtabackup二进制工具的一个软连接，但是实际的使用方法却不同，并且在以后的版本中会删除该工具")])]),s._v(" "),a("h3",{attrs:{id:"_4-2、xtrabackup备份原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2、xtrabackup备份原理"}},[s._v("#")]),s._v(" 4.2、xtrabackup备份原理")]),s._v(" "),a("p",[s._v("实现过程分为三个阶段：分别为 备份过程(backup阶段)、准备过程(prepare阶段)、恢复过程(copy back阶段)")]),s._v(" "),a("h3",{attrs:{id:"_4-2-1、备份过程-backup阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1、备份过程-backup阶段"}},[s._v("#")]),s._v(" 4.2.1、备份过程(backup阶段)")]),s._v(" "),a("p",[s._v("在备份的过程中会分为两种情况，主要是根据percona Server工具是否支持backup lock(备份锁)")]),s._v(" "),a("p",[s._v("backup lock(备份锁)：在全局范围内只对非innodb表加锁，所以持有该锁后无法修改非innodb表，但却不影响innodb表的DML。当然，因为是全局锁，所以也会阻塞DDL操作。")]),s._v(" "),a("p",[s._v("二进制日志锁：在全局范围内锁定二进制日志，所以会阻塞其他会话修改二进制日志。这样可以保证能够获取到二进制日志中一致性的位置坐标")]),s._v(" "),a("h3",{attrs:{id:"第一种情况-支持"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一种情况-支持"}},[s._v("#")]),s._v(" 第一种情况（支持）：")]),s._v(" "),a("ul",[a("li",[s._v("1、启动xtrabackup时，会记录LSN并拷贝redo log到xtrabackup_logfile文件中。")]),s._v(" "),a("li",[s._v("2、拷贝innodb表的数据文件（表空间文件*.ibd或者是ibdata1）此时补考呗frm文件")]),s._v(" "),a("li",[s._v("3、拷贝非innodb文件，拷贝之前需要对非innodb表进行加锁防止拷贝时有语句修改这些类型的表数据。xtrabackup通过lock tables for backup获取轻量级的backup locks来替代flush tables with read lock，因为它只锁定非innodb表，所以由此实现了innodb表的真正热备。")]),s._v(" "),a("li",[s._v("4、拷贝非innodb表的数据和.frm文件，拷贝其他存储引擎类型的文件。")]),s._v(" "),a("li",[s._v("5、当拷贝阶段完成后，最后获取二进制日志中一致性位置的坐标点、结束redo log的监控和拷贝、释放锁等。收尾阶段的过程是这样的：先通过lock binlog for bakcup来获取二进制 日志锁，然后结束redo log的监控和拷贝，再unlock tables释放表锁，随后获取二进制日志的一致性位置坐标点，最后unlock binlog释放二进制日志锁")]),s._v(" "),a("li",[s._v("6、如果一切都OK，xtrabackup将以状态码0退出。")])]),s._v(" "),a("h3",{attrs:{id:"第二种情况-不支持"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第二种情况-不支持"}},[s._v("#")]),s._v(" 第二种情况（不支持）：")]),s._v(" "),a("ul",[a("li",[s._v("1、启动xtrabackup时，会记录LSN并拷贝redo log到xtrabackup_logfile文件中。")]),s._v(" "),a("li",[s._v("2、拷贝innodb表的数据文件（表空间文件*.ibd或者是ibdata1）此时补考呗frm文件")]),s._v(" "),a("li",[s._v("3、拷贝非innodb文件，拷贝之前需要对非innodb表进行加锁防止拷贝时有语句修改这些类型的表数据。只能通过flush tables with read lock来获取全局读锁，但这样也同样会锁住   innodb表，杀伤力太大。")]),s._v(" "),a("li",[s._v("4、拷贝非innodb表的数据和.frm文件，拷贝其他存储引擎类型的文件。")]),s._v(" "),a("li",[s._v("5、当拷贝阶段完成后，最后获取二进制日志中一致性位置的坐标点、结束redo log的监控和拷贝、释放锁等。收尾阶段的过程是这样的：获取二进制日志的一致性坐标点、结束     redo log的监控和拷贝、释放锁。")]),s._v(" "),a("li",[s._v("6、如果一切都OK，xtrabackup将以状态码0退出。")])]),s._v(" "),a("p",[s._v("可以从图看对比更加详细，见下图：")]),s._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190911091804649-1567315924.png"),alt:"wxmp"}}),s._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190911091747944-250456180.png"),alt:"wxmp"}}),s._v(" "),a("h3",{attrs:{id:"_4-2-2、准备过程-prepare阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2、准备过程-prepare阶段"}},[s._v("#")]),s._v(" 4.2.2、准备过程(prepare阶段)")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('这个阶段的实质就是对备份的innodb数据应用redo log，该回滚的回滚，该前滚的前滚，最终保证xtrabackup_logfile中记录的redo log已经全部应用到备份数据页上，并且实现了一致性。当应用结束后，会重写"xtrabackup_logfile"再次保证该redo log和备份的数据是对应的。\n')])])]),a("h3",{attrs:{id:"_4-2-3、恢复过程-copy-back阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-3、恢复过程-copy-back阶段"}},[s._v("#")]),s._v(" 4.2.3、恢复过程(copy back阶段)")]),s._v(" "),a("p",[s._v("xtrabackup的恢复过程实质是将备份的数据文件和结构定义等文件拷贝回MySQL的datadir。同样可以拷贝到任意机器上。要求恢复之前MySQL必须是停止运行状态，且datadir是空目录")]),s._v(" "),a("h3",{attrs:{id:"_4-3、innobackupex工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3、innobackupex工具"}},[s._v("#")]),s._v(" 4.3、innobackupex工具")]),s._v(" "),a("h3",{attrs:{id:"_4-3-1、全备和恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-1、全备和恢复"}},[s._v("#")]),s._v(" 4.3.1、全备和恢复")]),s._v(" "),a("p",[s._v("条件：账号和密码，以及给定备份目录（默认xtrabackup连接数据库的时候从配置文件中去读取和备份相关的配置，可以使用选项--defaluts-file指定连接时的参数配置文件，但如果指定该选项，该选项只能放在第一个选项位置。）")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /backup           #新建备份目录                               ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chown -R mysql:mysql /backup        #修改目录拥有者                    ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# innobackupex --user=root --password=123456 /backup/  #备份     ")]),s._v("\n")])])]),a("p",[s._v("然后我们查看目录/backup/")]),s._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190911094004233-110191740.png"),alt:"wxmp"}}),s._v(" "),a("p",[s._v("备份目录下是一个以时间戳命名的目录，然后接着继续往下面看：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll /backup/2019-09-10_21-39-30/")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12340")]),s._v("\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("490")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 backup-my.cnf\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("365")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 ib_buffer_pool\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12582912")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 ibdata1\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 mysql\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 performance_schema\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 sys\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 test1\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 xtrabackup_binlog_info\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("135")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 xtrabackup_checkpoints\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("466")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 xtrabackup_info\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2560")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 xtrabackup_logfile\n")])])]),a("p",[s._v("其中：")]),s._v(" "),a("p",[s._v("mysql、performance_schemasys、test、test1为数据库的备份")]),s._v(" "),a("p",[s._v("ibdata1为共享表空间")]),s._v(" "),a("p",[s._v("backup-my.cnf是拷贝过来的配置文件，但是里面只包含[mysqld]配置片段和备份有关的选项")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_21-39-30"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat backup-my.cnf ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# This MySQL options file was generated by innobackupex.")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The MySQL server")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mysqld"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_checksum_algorithm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("crc32\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_log_checksum_algorithm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("strict_crc32\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_data_file_path")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ibdata1:12M:autoextend\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_log_files_in_group")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_log_file_size")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50331648")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_fast_checksum")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_page_size")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_log_block_size")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_undo_directory")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_undo_tablespaces")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("server_id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("redo_log_version")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("server_uuid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("74b64a5b-cfba-11e9-95d0-000c2994d425\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_key_id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])])]),a("p",[s._v("xtrabackup_binlog_info中记录的是当前使用的二进制日志文件")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_21-39-30"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat xtrabackup_binlog_info")]),s._v("\nmysql-bin.000008        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("154")]),s._v("\n")])])]),a("p",[s._v("xtrabackup_checkpoints中记录了备份的类型是全备还是增备，还有备份的起始、终止LSN号")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_21-39-30"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat  xtrabackup_checkpoints")]),s._v("\nbackup_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" full-backuped\nfrom_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nto_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2613099")]),s._v("\nlast_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2613108")]),s._v("\ncompact "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nrecover_binlog_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nflushed_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2613108")]),s._v("\n")])])]),a("p",[s._v("xtrabackup_info中记录的是备份过程中的一些信息。")]),s._v(" "),a("p",[s._v('xtrabackup_logfile是复制和监控后写的redo日志。该日志是备份后下一个操作"准备"的关键。只有通过它才能实现数据一致性')]),s._v(" "),a("p",[s._v("根据上节所说的xtrabackup的原理，我们知道在全备完之后，还有一个准备过程，这个过程主要是为了保证数据的一致性。因为坑你存在innodb数据，则还不能用来恢复。因为从xtrabackup开始备份的时候就监控着MySQL的redo log，在拷贝的innodb数据文件中很可能还有未提交的事务，并且拷贝完innodb数据之后还可能提交了事务或者开启了新的事务等等。总之，全备之后的状态不一定是一致的。")]),s._v(" "),a("p",[s._v('接下来进行准备阶段的操作：准备阶段使用的模式选项是"--apply-log"。准备阶段不会连接MySQL，所以不用指定连接选项如--user等。还有一个参数"--use-memory"，该选项默认值为100M，值越大准备的过程越快。')]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_21-39-30"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/backup/2019-09-10_21-39-30\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_21-39-30"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  innobackupex --apply-log `pwd` #等于 innobackupex --apply-log /backup/2019-09-10_21-39-30")]),s._v("\n")])])]),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190911095840144-986175278.png"),alt:"wxmp"}}),s._v(" "),a("p",[s._v("当出现如上状态，则表示准备阶段已经完成，则我们可以继续进行下一步操作了，即恢复操作。恢复过程要求停止服务器，并且datadir目录为空。所以接下来我们先准备这两个条件：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("-rw-r--r--   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1975750")]),s._v(" Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":21 redis-5.0.5.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/my.cnf | grep datadir #查找datadir目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("datadir")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mysql\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service mysqld stop #停止msyql服务")]),s._v("\nShutting down MySQL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(" SUCCESS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv /data/mysql/ /data/mysql_bak #备份文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /data/mysql")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chown -R mysql:mysql /data/mysql #新建")]),s._v("\n")])])]),a("p",[s._v('满足如上的条件之后我们进行恢复操作：恢复时使用的模式是"--copy-back"，选项后指定要恢复的源备份目录')]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# innobackupex --copy-back /backup/2019-09-10_21-39-30/")]),s._v("\n")])])]),a("p",[s._v("然后结尾提示：表示成功")]),s._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190911100510083-1986927830.png"),alt:"wxmp"}}),s._v(" "),a("p",[s._v("接下来我们查看datadir目录：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll /data/mysql")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("122932")]),s._v("\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root  root       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("365")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 ib_buffer_pool\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root  root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12582912")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 ibdata1\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root  root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50331648")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 ib_logfile0\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root  root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50331648")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 ib_logfile1\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root  root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12582912")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 ibtmp1\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4996")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":06 lgh3.err\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root  root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 mysql\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root  root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 performance_schema\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root  root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 sys\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root  root        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root  root        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 test1\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root  root        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 xtrabackup_binlog_pos_innodb\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root  root       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("466")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 xtrabackup_info\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root  root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":04 xtrabackup_master_key_id\n")])])]),a("p",[s._v("发现该目录的拥有者不是mysql用户，然后我们修改之：chown -R mysql:mysql /data/mysql，然后启动服务器")]),s._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190911100952028-670238536.png"),alt:"wxmp"}}),s._v(" "),a("p",[s._v("从上看出来，全备和恢复就成功了")]),s._v(" "),a("h3",{attrs:{id:"_4-3-2、增备和恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-2、增备和恢复"}},[s._v("#")]),s._v(" 4.3.2、增备和恢复")]),s._v(" "),a("p",[s._v("增量备份就是在全量备份的基础上进行增加新增数据的备份。xtrabackup实现增量备份的原理是对全备份的终点LSN和当前的LSN进行比较，增备时将从终点LSN开始一直备份到当前的LSN。在备份时也有redo log的监控线程，对于增备过程中导致LSN增长的操作也会写入到日志中。增备的实现依赖于LSN，所以只对innodb有效，对myisam表使用增备时，背后进行的是全备。")]),s._v(" "),a("p",[s._v("1、进行全备，这里重新备份一次：innobackupex --user=root --password=123456 /backup/")]),s._v(" "),a("p",[s._v("2、为了实现增量， 我们干掉test库：mysql -uroot -p123456 -e 'drop database test'，然后新增库，新增表等操作")]),s._v(" "),a("p",[s._v("3、查看xtrabackup_checkpoints可以得知相关的LSN")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_22-24-39"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat xtrabackup_checkpoints")]),s._v("\nbackup_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" full-backuped\nfrom_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nto_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2613682")]),s._v("\nlast_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2613691")]),s._v("\ncompact "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nrecover_binlog_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nflushed_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2613691")]),s._v("\n")])])]),a("p",[s._v('4、进行增备：使用"--incremental"选项表示增量备份，增量备份时需要通过"--incremental-basedir=fullback_PATH"指定基于哪个备份集备份，因为是第一次增备，所以要基于完全备份增量集。xtrabackup提供的选项"--incremental-lsn=N"可以显式指定增备的起始LSN，默认会自动获取。显式指定LSN时，可以无需提供增备的basedir。')]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("innobackupex --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" --incremental /backup/  --incremental-basedir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/2019-09-10_22-24-39/\n")])])]),a("p",[s._v("备份完成后，我们查看/backup/目录，看得出来新增了一个目录，然后我们进去看一下")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 backup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("248")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":24 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_22-24-39\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_22-33-59\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 backup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd 2019-09-10_22-33-59")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_22-33-59"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1160")]),s._v("\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("490")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 backup-my.cnf\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("365")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 ib_buffer_pool\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1130496")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 ibdata1.delta\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":33 ibdata1.meta\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 mysql\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 performance_schema\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 sys\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("79")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 test1\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("76")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 test2\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("76")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 test3\ndrwxr-x--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("76")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 test4\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 xtrabackup_binlog_info\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("139")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 xtrabackup_checkpoints\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("537")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 xtrabackup_info\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2560")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":34 xtrabackup_logfile\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-09-10_22-33-59"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat xtrabackup_checkpoints ")]),s._v("\nbackup_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" incremental\nfrom_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2613682")]),s._v("\nto_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2640367")]),s._v("\nlast_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2640376")]),s._v("\ncompact "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nrecover_binlog_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nflushed_lsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2640376")]),s._v("\n")])])]),a("p",[s._v("从上看出来，我们实现了增量的备份。接下来就是准备阶段了")]),s._v(" "),a("p",[s._v('增备的准备过程和全备的准备过程有点不一样，不到最后恢复的时候不能进行任何"准备"过程。为了保证将所有的备份集进行整合，需要使用在每个备份集的"准备"过程中使用"--redo-only"选项，这样应用日志时会"直线向前"直到最后一个备份集。它的本质是向全备集中不断的追加应用增备中的日志。但是，最后一个增备集需要作为备份集整合的终点，所以它不能使用"--redo-only"选项。整合完成之后，原来的全备就已经完整了，这时再对追加完成的全备集进行一次"准备"即可用于后面的恢复。')]),s._v(" "),a("p",[s._v("假设我们在全备（假设为bak_all）的基础上，进行了增备bak1,bak2（bak文件都代表备份的以时间戳命名的目录）两次，那么我们的准备过程就如下：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 对整合的开始备份集——全备集应用日志，并指定"--redo-only"表示开始进入日志追加')]),s._v("\ninnobackupex --apply-log --redo-only /backup/2019-09-10_22-24-39  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这里2019-09-10_22-24-39代表bak_all")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 对第一个增备集进行"准备"，将其追加到全备集中')]),s._v("\ninnobackupex --apply-log --redo-only /backup/bak_all --incremental-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak1\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 对第二个增备集进行"准备"，将其追加到全备集中，但是不再应用"--redo-only"，表示整合的结束点')]),s._v("\ninnobackupex --apply-log /backup/bak_all --incremental-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak2\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 对整合完成的全备集进行一次整体的"准备"')]),s._v("\ninnobackupex --apply-log /backup/bak_all\n")])])]),a("p",[s._v("接下来进行恢复过程。步骤同全备恢复一样，清空datadir目录，stop服务")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /data/mysql\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" mysqld stop\ninnobackupex --copy-back /backup/2019-09-10_23-07-28/\n")])])]),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/bak/intro/1271254-20190911111525352-64838789.png"),alt:"wxmp"}}),s._v(" "),a("p",[s._v("到这里就完成了增备的恢复，这里实验了好几次，所以好几个文件夹的名字可能是不一样的。")]),s._v(" "),a("p",[s._v("4.3.3、表的导入和导出")]),s._v(" "),a("p",[s._v('导出表是在"准备"的过程中进行的，不是在备份的时候导出。对于一个已经备份好的备份集，使用"--apply-log"和"--export"选项即可导出备份集中的表')]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v(" innobackupex --apply-log --export /backup/2019-09-10_23-07-28/\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 test2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/backup/2019-09-10_23-07-28/test2\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@lgh3 test2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("132")]),s._v("\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":11 db.opt\n-rw-r--r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("423")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":23 gxt.cfg\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":23 gxt.exp\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8586")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":11 gxt.frm\n-rw-r----- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98304")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":11 gxt.ibd\n")])])]),a("p",[s._v("如上多了一个exp结尾的文件。其中.cfg文件是一种特殊的innodb数据字典文件，它和exp文件的作用是差不多的，只不过后者还支持在xtradb中导入")]),s._v(" "),a("p",[s._v('导入则是要在mysql服务器上导入来自于其它服务器的某innodb表，需要先在当前服务器上创建一个跟原表表结构一致的表，而后才能实现将表导入，将来自于"导出"表的的.ibd和.exp文件复制到当前服务器的数据目录或者是也可以复制.cfg文件。复制过去后要修改拥有者权限：chown -R mysql:mysql /data/mysql')]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ALTER TABLE test2.gxt  DISCARD TABLESPACE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#干掉表空间")]),s._v("\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ALTER TABLE test2.gxt IMPORT TABLESPACE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("这样即完成了单个表的导出和导入")]),s._v(" "),a("h3",{attrs:{id:"_4-3-4、部分备份和恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-4、部分备份和恢复"}},[s._v("#")]),s._v(" 4.3.4、部分备份和恢复")]),s._v(" "),a("p",[s._v('部分备份只有一点需要注意：在恢复的时候不要通过"--copy-back"的方式拷贝回datadir，而是应该使用导入表的方式。尽管使用拷贝的方式有时候是可行的，但是很多情况下会出现数据库不一致的状态。')]),s._v(" "),a("p",[s._v("创建部分备份有三种方式：")]),s._v(" "),a("ul",[a("li",[s._v('1、通过"--include"选项可以指定正则来匹配要备份的表，这种方式要使用完整对象引用格式，即db_name.tab_name的方式。')]),s._v(" "),a("li",[s._v('2、将要备份的表分行枚举到一个文件中，通过"--tables-file"指定该文件。')]),s._v(" "),a("li",[s._v('3、或者使用"--databases"指定要备份的数据库或表，指定备份的表时要使用完整对象引用格式，多个元素使用空格分开。')])]),s._v(" "),a("p",[s._v("使用前两种部分备份方式，只能备份innodb表，不会备份任何myisam，即使指定了也不会备份。而且要备份的表必须有独立的表空间文件，也就是说必须开启了innodb_file_per_table，更精确的说，要备份的表是在开启了innodb_file_per_table选项之后才创建的。第三种备份方式可以备份myisam表")]),s._v(" "),a("p",[s._v("例如：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("innobackupex --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" --include"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^back*[.]num_*'")]),s._v(" /backup/\n")])])]),a("p",[s._v("备份好之后会在/backup/目录下生成一个以时间戳命名的目录，就是备份的目录")]),s._v(" "),a("p",[s._v("恢复过程同全备的恢复过程：**见4.3.1节")]),s._v(" "),a("h3",{attrs:{id:"_4-4、xtrabackup工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4、xtrabackup工具"}},[s._v("#")]),s._v(" 4.4、xtrabackup工具")]),s._v(" "),a("p",[s._v('xtrabackup工具有两种常用运行模式："--backup"和"--prepare"。还有两个比较少用的模式："--stats"和"--print-param"。')]),s._v(" "),a("h3",{attrs:{id:"_4-4-1、全备和恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-1、全备和恢复"}},[s._v("#")]),s._v(" 4.4.1、全备和恢复")]),s._v(" "),a("p",[s._v("备份路径由参数--target-dir指定：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("xtrabackup --backup --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" --datadir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mysql --target-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak_all\n")])])]),a("p",[s._v("准备：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("xtrabackup --prepare --target-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak_all\n")])])]),a("p",[s._v("恢复：xtrabackup自身不能恢复，只能通过拷贝备份集的方式来恢复。例如使用rsync或者cp等。另外，恢复时也一样要求MySQL是stop状态，datadir是空目录。并且拷贝完成后要修改datadir中文件的所有者和属组为mysql用户和组。")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" mysqld stop\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /data/mysql/*\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rsync")]),s._v(" -azP /backup/bak_all/* /data/mysql\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R mysql.mysql /data/mysql\n")])])]),a("h3",{attrs:{id:"_4-4-2、增备和恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-2、增备和恢复"}},[s._v("#")]),s._v(" 4.4.2、增备和恢复")]),s._v(" "),a("p",[s._v("1、全备：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("xtrabackup --backup --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" --datadir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mysql --target-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak_all\n")])])]),a("p",[s._v("2、增备")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("xtrabackup --backup --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" --target-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/bacpup/bak1 --incremental-basedir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak_all --datadir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mysql/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#增备1")]),s._v("\nxtrabackup --backup --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" --target-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/bacpup/bak2 --incremental-basedir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak1 --datadir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/mysql/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#增备2")]),s._v("\n")])])]),a("p",[s._v("3、准备")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("xtrabackup --prepare --apply-log-only --target-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak_all\nxtrabackup --prepare --apply-log-only --target-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak_all --incremental-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak1\nxtrabackup --prepare --target-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak_all --incremental-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/bak2\n")])])]),a("p",[s._v("4、恢复：**见4.3.1节全备恢复")]),s._v(" "),a("h3",{attrs:{id:"其他mysql文章请看-mysql学习系列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他mysql文章请看-mysql学习系列"}},[s._v("#")]),s._v(" 其他mysql文章请看："),a("a",{attrs:{href:"https://www.cnblogs.com/zsql/p/11493186.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("MYSQL学习系列"),a("OutboundLink")],1)]),s._v(" "),a("h3",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考：")]),s._v(" "),a("p",[s._v("《mysql技术内幕：innodb存储引擎》")]),s._v(" "),a("p",[s._v("https://www.cnblogs.com/f-ck-need-u/p/9018716.html#auto_id_13")]),s._v(" "),a("p",[s._v("作者："),a("a",{attrs:{href:"https://www.cnblogs.com/zsql/",target:"_blank",rel:"noopener noreferrer"}},[s._v("一寸HUI"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("出处：https://www.cnblogs.com/zsql/")]),s._v(" "),a("p",[s._v("如果您觉得阅读本文对您有帮助，请点击一下右下方的"),a("strong",[s._v("推荐")]),s._v("按钮，您的"),a("strong",[s._v("推荐")]),s._v("将是我写作的最大动力！")]),s._v(" "),a("p",[s._v("版权声明：本文为博主原创或转载文章，欢迎转载，"),a("strong",[s._v("但转载文章之后必须在文章页面明显位置注明出处")]),s._v("，否则保留追究法律责任的权利。")]),s._v(" "),a("h2",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),a("ul",[a("li",[s._v("https://www.cnblogs.com/zsql/p/11498864.html")])])])}),[],!1,null,null,null);t.default=e.exports}}]);