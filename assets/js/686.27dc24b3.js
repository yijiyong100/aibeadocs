(window.webpackJsonp=window.webpackJsonp||[]).push([[686],{1202:function(s,a,t){"use strict";t.r(a);var e=t(53),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("本文主要是介绍 MySQL-运维命令汇总 。")])]),s._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#mysql常用命令汇总-偏向运维管理"}},[s._v("MySQL常用命令汇总（偏向运维管理）")]),t("ul",[t("li",[t("a",{attrs:{href:"#基础部分"}},[s._v("基础部分")])]),t("li",[t("a",{attrs:{href:"#实例参数部分"}},[s._v("实例参数部分")])]),t("li",[t("a",{attrs:{href:"#mha-常用命令"}},[s._v("MHA 常用命令")])]),t("li",[t("a",{attrs:{href:"#其他部分-binlog和主从复制"}},[s._v("其他部分(binlog和主从复制)")])]),t("li",[t("a",{attrs:{href:"#其他部分-免密登录"}},[s._v("其他部分(免密登录)")])]),t("li",[t("a",{attrs:{href:"#其他部分-备份和事件"}},[s._v("其他部分(备份和事件)")])]),t("li",[t("a",{attrs:{href:"#其他部分-日志和存储过程"}},[s._v("其他部分(日志和存储过程)")])])])]),t("li",[t("a",{attrs:{href:"#参考文章"}},[s._v("参考文章")])])])]),t("p"),s._v(" "),t("h2",{attrs:{id:"mysql常用命令汇总-偏向运维管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql常用命令汇总-偏向运维管理"}},[s._v("#")]),s._v(" MySQL常用命令汇总（偏向运维管理）")]),s._v(" "),t("h3",{attrs:{id:"基础部分"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基础部分"}},[s._v("#")]),s._v(" 基础部分")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("select @@version; ##查询当前mysql的版本.")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'port';##查看mysql实例的端口。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'socket';##查看实例的socket数据。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'datadir';##查看实例的数据路径。")])]),s._v(" "),t("li",[t("p",[s._v("show databases;  ##显示所有数据库名的命令 。")])]),s._v(" "),t("li",[t("p",[s._v("desc tablename;  ## 显示表结构和列结构的命令。")])]),s._v(" "),t("li",[t("p",[s._v("show processlist \\G;##显示正在执行的线程。")])]),s._v(" "),t("li",[t("p",[s._v("explain ##查看语句的执行计划。")])]),s._v(" "),t("li",[t("p",[s._v("show index from table_name ##查看表的索引情况。")])]),s._v(" "),t("li",[t("p",[s._v("select * from STATISTICS where table_name='XXX'\\G ##查看表的统计信息。")])]),s._v(" "),t("li",[t("p",[s._v("select @@max_allowed_packet; ## 查询定义的packet大小。")])]),s._v(" "),t("li",[t("p",[s._v("show master status;##查看master状态。可以查看 最后(最新)一个binlog日志的编号名称，及其最后一个操作事件pos结束点(Position)值")])])]),s._v(" "),t("p",[s._v("show slave status ;##查看slave状态。")]),s._v(" "),t("ol",{attrs:{start:"13"}},[t("li",[t("p",[s._v("show master logs;##查看所有的log文件，在主服务器上执行。(即查看所有binlog日志列表)")])]),s._v(" "),t("li",[t("p",[s._v("purge binary logs to 'mysql-bin3306.000003'; #mysql-bin3306.000003之前的日志被purge。")])]),s._v(" "),t("li",[t("p",[s._v("show warnings; ##显示最近的警告详情。")])]),s._v(" "),t("li",[t("p",[s._v("show variables \\G; ##查看当前mysqld的所有参数，包括默认值。")])]),s._v(" "),t("li",[t("p",[s._v("show grants for 'username'@'hostip' \\G; ##查看某一个用户的权限,请替换参数username 和 hostip。")])]),s._v(" "),t("li",[t("p",[s._v("show create table tablename \\G; ##查看某表的创建脚本")])])]),s._v(" "),t("h3",{attrs:{id:"实例参数部分"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实例参数部分"}},[s._v("#")]),s._v(" 实例参数部分")]),s._v(" "),t("ol",{attrs:{start:"19"}},[t("li",[t("p",[s._v("show variables like 'log_slave%' \\G; ##指定条件的参数设置查询，例如查询以log_slave开头的参数设置。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'slow_query_log';##查看是否开启了慢查询日志；ON代表开启。可以在线打开。set global slow_query_log = 1;")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'slow_query_log_file';## 查看慢查询日志的路径。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'long_query_time'; ##查看慢查询定义的阈值，单位是秒。记录的查询是大于该值，不包括该值。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'log_output'; ##查看日志的输出格式（file或table）。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'log_timestamps';##查看日志的时间信息，UTC时间或者SYSTEM时间。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'log_slow_slave_statements';##查看从服务器是否开启慢查询日志，ON代表开启。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'log_queries_not_using_indexes';##将没有使用索引的SQL语句记录到慢查询日志中。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'log_throttle_queries_not_using_indexes';##集合上面的参数一起使用，限制每分钟内，在慢查询日志中，记录没有使用\n索引的次数。避免日志快速增长。")])]),s._v(" "),t("li",[t("p",[s._v('show variables like "default%tmp%";查看创建的临时表的存储引擎类型。')])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'innodb_log_file_size';##查询log文件大小。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'innodb_page_size'; ##查询页的大小。一旦数据库通过innodb_page_size设置完成，则后续无法更改。innodb_page_size\n是针对普通表的，压缩表不受限制。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'innodb_buffer_pool_size';##查看缓冲池的大小，每次读写数据都是通过buffer pool；当buffer pool中没有所需的数据\n时，才去硬盘中获取。该值设置的越大越好。buffer pool 也是以页（page）为单位的，且大小和innodb_page_size一致。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'innodb_buffer_pool_instances'; ##设置多少个缓冲池。设置多个instance可将热点打散，提高并发性能（建议设置成cpu\n个数值）")])]),s._v(" "),t("li",[t("p",[s._v("show engine innodb status \\G;##查看buffer pool的状态。（查看默认存储引擎的类型：  SELECT @@default_storage_engine;）")])]),s._v(" "),t("li",[t("p",[s._v("set global innodb_buffer_pool_size=2"),t("em",[s._v("1024")]),s._v("1024*1024;##在线调整innodb_buffer_pool_size。MySQL 5.7之前的版本，修改该值，需要重启。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'innodb_buffer_pool_dump_at_shutdown'; ##在MySQL 5.6 以后，可以在停机的时候dump出buffer pool的数据，然后在\n启动的时候Load进buffer pool。该功能可以在MySQL启动时自动预热，无需人工干预。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'innodb_buffer_pool_dump_pct';##dumpd 百分比，是每个buffer pool文件，而不是整体。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'innodb_buffer_pool_load_at_startup';## 启动时加载dump的文件，恢复到buffer pool中。dump的越多，启动的越慢。")])]),s._v(" "),t("li",[t("p",[s._v("select * from innodb_lock_waits;##查看锁的信息，在数据库sys下执行。")])]),s._v(" "),t("li",[t("p",[s._v("show variables like 'transaction_isolation'; ##查看隔离级别")])]),s._v(" "),t("li",[t("p",[s._v("set transaction_isolation='read-committed'; ##设置隔离级别。")])])]),s._v(" "),t("p",[s._v("41.show variables like 'innodb_print_all_deadlocks';##设置为ON，表示将死锁信息打印到err_log中。")]),s._v(" "),t("p",[s._v('42.show variables like "%innodb_flush_log_at_timeout%";##master thread 每秒刷新redo的buffer到logfile。5.7版本可以设置刷新间隔时间，\n默认是1秒。')]),s._v(" "),t("ol",{attrs:{start:"43"}},[t("li",[s._v("show variables like 'binlog_format';##查看binlog的类型。statement 记录SQL语句；ROW 记录SQL语句操作的那些行（行的变化）；mixed 混\n合statement 和 Row 格式（不推荐）。")])]),s._v(" "),t("h3",{attrs:{id:"mha-常用命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mha-常用命令"}},[s._v("#")]),s._v(" MHA 常用命令")]),s._v(" "),t("ol",{attrs:{start:"44"}},[t("li",[t("p",[s._v("masterha_check_ssh --conf=/etc/masterha/app1.conf  ##检查MHA集群SSH配置。")])]),s._v(" "),t("li",[t("p",[s._v("masterha_check_repl --conf=/etc/masterha/app1.conf  ##检查整个集群的复制状况。")])]),s._v(" "),t("li",[t("p",[s._v('masterha_check_status --conf=/etc/masterha/app1.conf ##检查MHA Manager的状态：如果正常，会显示"PING_OK"，否则会显示"NOT_RUNNING" ，这代表MHA监控没有开启。')])]),s._v(" "),t("li",[t("p",[s._v("nohup masterha_manager --conf=/etc/masterha/app1.conf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/masterha/app1/manager.log 2>&1 & ###监控进程通过nohup管理，可以通过jobs查看后台进程。")])]),s._v(" "),t("li",[t("p",[s._v("show slave hosts;##在master节点上执行，查看Slave节点数据。")])]),s._v(" "),t("li",[t("p",[s._v("CHANGE MASTER TO MASTER_HOST='172.XXX.XXX.XXX',MASTER_USER='replname',MASTER_PASSWORD='pwd',MASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=154; ##change master 示例")])]),s._v(" "),t("li",[t("p",[s._v("若在Slave机器上对数据库进行修改或者删除，会导致主从的不一致，需对Slave机器设置为read_only = 1 ，让Slave提供只读操作。")])])]),s._v(" "),t("p",[s._v("注意： read_only 仅仅对没有SUPER权限的用户有效（即 mysql.user表的Super_priv字段为Y），一般给App 的权限是不需要SUPER权限的。参数super_read_only 可以将有SUPER权限的用户也设置为只读，且该参数设置为ON 后， read_only 也跟着自动设置为ON。")]),s._v(" "),t("ol",{attrs:{start:"52"}},[t("li",[t("p",[s._v('show variables like "server_uuid";## 查看UUID。 GTID（G lobal T ransaction Id entifier） 全局事物ID。GTID = Server_UUID +\nTransaction_ID 其中 Server_UUID 是全局唯一的，Transaction_ID 是自增的。')])]),s._v(" "),t("li",[t("p",[s._v('show variables like "%gtid%";##查看gtid相关数据及配置')])])]),s._v(" "),t("p",[s._v("54.从服务器跳过一个错误的事务")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("  步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": 关闭复制\n  stop slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" ： 设置 gtid_next 为回放失败的gtid\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" gtid_next"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'4e659069-3cd8-11e5-9a49-001c4270714e:1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在session里设置gtid_next，即跳过这个GTID")]),s._v("\n  步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" : 执行一个空的事物，让回放失败的gtid对应到这个空的事物\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" : 还原gtid_next为automatic\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SESSION")]),s._v(" GTID_NEXT "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" AUTOMATIC"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#把gtid_next设置回来")]),s._v("\n  步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(": 开启复制\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("ol",{attrs:{start:"55"}},[t("li",[s._v("通过GTID的复制都是没有指定MASTER_LOG_FILE和MASTER_LOG_POS的，所以通过GTID复制都是从最先开始的事务开始，除非在自己的binlog里面有执行过之前的记录，才会继续后面的执行。Slave如何跳过purge的部分，而不是在最先开始的事务执行。")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("   步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：在主上执行，查看被"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("purge")]),s._v("的GTID\n   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gtid_purged'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   以下步骤在从上执行，跳过这个GTID：\n   步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  stop slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n  reset master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  步骤"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h3",{attrs:{id:"其他部分-binlog和主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他部分-binlog和主从复制"}},[s._v("#")]),s._v(" 其他部分(binlog和主从复制)")]),s._v(" "),t("ol",{attrs:{start:"56"}},[t("li",[t("p",[s._v("show binlog events in 'mysql-bin.000008'; ##查看指定binlog中的内容。")])]),s._v(" "),t("li",[t("p",[s._v("flush binary logs;#刷新日志，并且会产生一个新的日志文件。")])]),s._v(" "),t("li",[t("p",[s._v('show variables like "binlog_rows_query_log_events";##设置为ON，可以在ROW格式下，看到SQL的信息。')])]),s._v(" "),t("li",[t("p",[s._v('show variables like "binlog_cache_size";##binlog默认写入到binlog_cache中，系统默认是32K，当有一个大的事务时（几百兆），内存中显然\n放不下那么多binlog，所以会记录到磁盘上。')])]),s._v(" "),t("li",[t("p",[s._v("show global status like 'binlog_cache_disk_use';##记录了使用临时文件写二进制日志的次数。注意：写日志本来就停满的，如果cache写不下，\n再写入磁盘，然后再写binlog，就是写入2次磁盘，会更慢。如果参数binlog_cache_disk_use次数很多，就要看一下binlog_cache_size设置是否太小，\n或者事务本身是否太大。")])])]),s._v(" "),t("p",[s._v("62.xtrabackup 只能备份innodb存储引擎表（用的较少）；innobackupex可以备份其他存储引擎（含innodb）。innobackupex在xtrabackup的基础上做\n了包装，可以兼容各种存储引擎。")]),s._v(" "),t("p",[s._v("63 .mysqldump重要参数 --all-databases ：备份所有的数据库;--databases DB1 [DB2 DB3] ：备份指定的数据库;--single-transaction ： 在一个\n事物中导出，确保产生一致性的备份，当前只对innodb支持;--master-data ： 备份的时候dump出CHANGE MASTER 信息（file 和 pos），可供主从复制\n的时候使用， 默认值为1,当值设置为2 的时候，也会dump出信息，但是会被注释掉 。")]),s._v(" "),t("p",[s._v("参数说明：")]),s._v(" "),t("ul",[t("li",[s._v("-B：指定数据库")]),s._v(" "),t("li",[s._v("-F：刷新日志")]),s._v(" "),t("li",[s._v("-R：备份存储过程等")])]),s._v(" "),t("p",[s._v("由于上面在全备份的时候使用了-F选项，那么当数据备份操作刚开始的时候系统就会自动刷新log，这样就会自动产生\n一个新的binlog日志，这个新的binlog日志就会用来记录备份之后的数据库“增删改”操作")]),s._v(" "),t("ol",{attrs:{start:"64"}},[t("li",[s._v("show variables like '%slave_parallel_workers%';##从数据库用来还原的并发线程数。")])]),s._v(" "),t("p",[s._v("65.通过 mysqlbinlog工具去查看二进制文件binlog，内容较多，不容易分辨查看pos点信息。")]),s._v(" "),t("p",[s._v("mysql> show binlog events [IN 'log_name'] [FROM pos] [LIMIT [offset,] row_count];")]),s._v(" "),t("p",[s._v("选项解析：IN 'log_name' 指定要查询的binlog文件名(不指定就是第一个binlog文件)\nFROM pos 指定从哪个pos起始点开始查起(不指定就是从整个文件首个pos点开始算)\nLIMIT [offset,] 偏移量(不指定就是0)\nrow_count 查询总条数(不指定就是所有行)")]),s._v(" "),t("p",[s._v("66.从binlog日志恢复数据")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v(" 恢复语法格式：\n "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysqlbinlog mysql-bin.0000xx | mysql -u用户名 -p密码 数据库名（上面的mysql 可以是mysql可执行文目录bin下的mysql文件，例如 /data/mysql57/bin/mysql，如果是多实例或者socket不是默认的，还需指定 -S 选项。）例如以下的一个恢复案例")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql57"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysqlbinlog  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--no-defaults --start-position=1210 --stop-position=2019 --database=测试数据库 /data/mysql_test/mysql3306_bin.000009 |  /data/mysql57/bin/mysql -S /tmp/mysql_3307.sock -u用户名 -p密码")]),s._v("\n 常用选项：\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--start-position=???                   起始pos点")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--stop-position=???                    结束pos点")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('--start-datetime="XXXXXXX"             起始时间点')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('--stop-datetime="XXXXXXXX"             结束时间点')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--database=要恢复的数据库名字             指定只恢复zyyshop数据库(一台主机上往往有多个数据库，只限本地log日志)")]),s._v("\n            \n  不常用选项：    \n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("u "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--user=name              Connect to the remote server as username.连接到远程主机的用户名")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--password[=name]        Password to connect to remote server.连接到远程主机的密码")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("h "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--host=name              Get the binlog from server.从远程主机上获取binlog日志")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--read-from-remote-server   Read binary logs from a MySQL server.从某个MySQL服务器上读取binlog日志")]),s._v("\n\n 小结：实际是将读出的binlog日志内容，通过管道符传递给mysql命令。这些命令、文件尽量写成绝对路径；\n")])])]),t("p",[s._v("67.查看某数据库下账号")]),s._v(" "),t("p",[s._v("select * from mysql.db WHERE db LIKE 'db_name';")]),s._v(" "),t("p",[s._v("（root超级权限的账号除外）")]),s._v(" "),t("p",[s._v("68.mysql 5.7 新特性中在线in-place 修改字段的大小（VARCHAR inplace enlarge）")]),s._v(" "),t("p",[s._v("255字节长度是个门槛；不跨越255长度门槛即可在线调大；")]),s._v(" "),t("p",[s._v("没必要再为VARCHAR列预留更大长度；缩短长度不能in-place。")]),s._v(" "),t("p",[s._v("提示错误如下：")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("ERROR "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1846")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("A000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALGORITHM")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("INPLACE "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("is")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("supported"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Reason: Cannot change "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("column")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" INPLACE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Try "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALGORITHM")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("COPY\n")])])]),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/basic/sum-1.png"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("如果没有 ALGORITHM=INPLACE 参数是可以修改的。例如")]),s._v(" "),t("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/basic/sum-2.png"),alt:"wxmp"}}),s._v(" "),t("p",[s._v("思考点：为什么255字节长度是个门槛？")]),s._v(" "),t("p",[s._v("This is true as long as the number of length bytes required by a VARCHAR column remains the same.只要修改字段后字段varchar所占字节数和原先的相同就能实现，例如对于 VARCHAR 值在 0到 255,只需要一个bytes. 对于 VARCHAR 的值是 256 bytes 或者大于256 需要两个字节.这样的话,通过 in-place ALTER TABLE 只支持0到255 之间的修改，或者说256 以及大于256之间修改.in-place alter table 不支持小于256的varchar值变更为大于256的值。因为在这种情况下存储的字节会从1个字节变为两个字节。（这里需要着重说明的一点是需要针对不同的字符集来对应如果是英文 0-255 随便修改如果是其它字符集那么就需要注意了因为不同字符集占存储位不同）")]),s._v(" "),t("ol",{attrs:{start:"69"}},[t("li",[s._v("多源复制时（此处单只多个实例中的数据库复制同步到一个从实例中，即从实例上的数据库同步来源于多个主实例）。")])]),s._v(" "),t("p",[s._v("如果们在源A实例上删除一个账号，在源B上也删除同一个账号，第二次执行时，就会导致主从异常，因为从库上没有了这个账号信息。")]),s._v(" "),t("p",[s._v("在从库上执行： show slave status;")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("Last_SQL_Errno: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1396")]),s._v("\nLast_SQL_Error: Coordinator stopped because there were error"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" the worker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" The most recent failure being: Worker "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" failed executing "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ANONYMOUS'")]),s._v(" at master log mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000")]),s._v("XXX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" end_log_pos XXxxxxxx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" See error log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("or")]),s._v(" performance_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_applier_status_by_worker "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" more details about this failure "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("or")]),s._v(" others"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("any")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("根据提示，查看表performance_schema.replication_applier_status_by_worker")]),s._v(" "),t("p",[s._v("其相关信息为：")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n         CHANNEL_NAME: QQ_DO15060\n            WORKER_ID: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n            THREAD_ID: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v("\n        SERVICE_STATE: "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFF")]),s._v("\nLAST_SEEN_TRANSACTION: ANONYMOUS\n    LAST_ERROR_NUMBER: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1396")]),s._v("\n   LAST_ERROR_MESSAGE: Worker "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" failed executing "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ANONYMOUS'")]),s._v(" at master log mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000")]),s._v("XXX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" end_log_pos XXXXXx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Error "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Operation DROP USER failed for '")]),s._v("QQ_user_woaizhonghua"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@'")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("108.108")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".108")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" query"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Query: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'drop user '")]),s._v("QQ_user_woaizhonghua"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@'")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("108.108")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".108")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n LAST_ERROR_TIMESTAMP: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2017")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("02")]),s._v("\n")])])]),t("p",[s._v("解决方案为：Step 1 先创建QQ_user_woaizhonghua 账号 ；Step 2: stop slave for channel 'QQ_DO15060';Step 3 : start slave for channel 'QQ_DO15060';此时再次查看状态，恢复正常。")]),s._v(" "),t("p",[s._v("注意：这个多源复制情况下删除账号，创建账号同样是这个问题。如果源实例A创建了账号User1，此时会同步到了从实例B上。过了一段时间源实例B再创建了账号User1，就会导致主从同步报错。")]),s._v(" "),t("p",[t("strong",[s._v("70. MHA 中关于VIP 增减")])]),s._v(" "),t("p",[s._v("添加：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" ens3:1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("178.10")]),s._v(".10.19/23  \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#命令解释ifconfig 网卡名:1 虚拟IP/子网掩码，可以通过ip addr 获取")]),s._v("\n\narping -q -c "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" -U -I ens3 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("178.10")]),s._v(".10.19\n\n虚拟IP刷新生效\n")])])]),t("p",[s._v("移除虚拟IP：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" 网卡:"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$key")]),s._v(" down\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("###例如 上面添加的虚拟IP：")]),s._v("\n/sbin/ifconfig ens3:1 down\n")])])]),t("h3",{attrs:{id:"其他部分-免密登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他部分-免密登录"}},[s._v("#")]),s._v(" 其他部分(免密登录)")]),s._v(" "),t("p",[t("strong",[s._v("71.无用户密码条件下SSH免密钥登录设置")])]),s._v(" "),t("p",[s._v("搭建MHA，必须先搭建Server节点的SSH免密钥登录设置，但是因为安全要求，我们可能只能通过堡垒机登陆，但没有用户相应的密码。")]),s._v(" "),t("p",[s._v("step1 生成密钥文件和私钥文件(id_rsa,id_rsa.pub)")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v(" ssh"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("keygen "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t rsa\n")])])]),t("p",[s._v("注意：此文件位于目录.ssh 下( 目录可 "),t("strong",[s._v("ll -d ~/.ssh")]),s._v(" 查看)，通过ll -a 查看。")]),s._v(" "),t("p",[s._v("如果需要转到root账号下，可执行 sudo su -")]),s._v(" "),t("p",[s._v("重点在第二步，怎么在没有账号密码的情况下，实现")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("ssh"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("copy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ssh"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("id_rsa"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pub "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@17.10.XXX.XXX")]),s._v("\n")])])]),t("p",[s._v("因为此步需要输入密码。")]),s._v(" "),t("p",[s._v("知识补充：")]),s._v(" "),t("p",[s._v("ssh-copy-id - 将你的公共密钥"),t("strong",[s._v("填充")]),s._v("到一个远程机器上的authorized_keys文件中。（注意是填充，不是覆盖）")]),s._v(" "),t("p",[s._v("参数 -i：指定公钥文件。")]),s._v(" "),t("p",[t("strong",[s._v("解决方案：")])]),s._v(" "),t("p",[s._v("其实不一定需要通过这个ssh-copy-id命令进行数据的copy,我们可以"),t("strong",[s._v("直接通过复制粘贴文件中的数据就可以")]),s._v("。\n即将本地主机的公钥id_rsa.pub 内容 追加 到远程主机的authorized_keys文件内即可。注意是追加。")]),s._v(" "),t("p",[s._v("此类方法已通过线上使用。")]),s._v(" "),t("ol",{attrs:{start:"72"}},[t("li",[s._v("搭建MySQL主从，start slave；查看主从状态。")])]),s._v(" "),t("div",{staticClass:"language-yml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Master_SSL_Verify_Server_Cert")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" No\n         "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Last_IO_Errno")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2003")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Last_IO_Error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("error connecting to master 'q123q_wei123xin@110.110.110.111:3308' - retry-time")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("60  retries")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Last_SQL_Errno")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Last_SQL_Error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n")])])]),t("p",[s._v("查看log 错误类似，")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2018")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("70664")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ERROR"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Slave I"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("O: error connecting "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" master "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'q123q_wei123xin@110.110.110.111:3308'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" retry"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("time")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("  retries: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Error_code: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2003")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-----")]),s._v("\n")])])]),t("p",[s._v("1.密码不对 2.POS不对 3.网络问题")]),s._v(" "),t("p",[s._v("可以Ping的通，使用账号密码从从节点远程主节点OK （排除问题1）；多次配置，xtraback 和mysqldump 都有问题（基本排除问题 2).")]),s._v(" "),t("p",[s._v("难道是网络问题？！")]),s._v(" "),t("p",[s._v("最后结果是 ： 非标准端口上的 Mysql复制连接错误（非标准端口是指除了3306端口以外的MySQL端口 ）。")]),s._v(" "),t("p",[s._v("必须在系统上设置 （注意：这里指从库系统中）")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# semanage port -a -t mysqld_port_t -p tcp 3308    （3308指端口号）")]),s._v("\n")])])]),t("h3",{attrs:{id:"其他部分-备份和事件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他部分-备份和事件"}},[s._v("#")]),s._v(" 其他部分(备份和事件)")]),s._v(" "),t("p",[t("strong",[s._v("73 Xtrabackup注意事项")])]),s._v(" "),t("p",[s._v("如果使用的是xtrabackup，注意从节点会把event还原上去，可能会造成数据不一致，同步失败的问题。如果主节点有event，需要手动关闭从节点的event。例如，主节点有归档删除数据的event，从节点需要关闭，否则报错。类似如下错误：")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("Could "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("execute")]),s._v(" Delete_rows event "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" ????DB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Can"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t find record in '")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("', Error_code: 1032; handler error HA_ERR_KEY_NOT_FOUND; the event'")]),s._v("s master log "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FIRST")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" end_log_pos XXXXXXX\n")])])]),t("p",[t("strong",[s._v("74 event 相关命令")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("\n查看event是否开启 : "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%event_sche%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n将事件计划开启 : "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" event_scheduler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n将事件计划关闭 : "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" event_scheduler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n（上面参数的设置，注意是否同时修改了my"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cnf文件，防止重启失效）\n关闭事件任务 : "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" event eventName "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" completion preserve "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("disable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n开启事件任务 : "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" event eventName "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" completion preserve "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n查看事件任务 : "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" events \\G"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n（ 也可通过命令"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("full")]),s._v(" processlist 查看event。显示为"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("User")]),s._v("：event_scheduler； State"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("Waiting "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("next")]),s._v(" activation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("）\n\n")])])]),t("h3",{attrs:{id:"其他部分-日志和存储过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他部分-日志和存储过程"}},[s._v("#")]),s._v(" 其他部分(日志和存储过程)")]),s._v(" "),t("p",[t("strong",[s._v("75 MySQL 日志文件的截断和新建")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("主要用到的语法为：flush"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("logs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("log_type "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("仅适用于mysql5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.")]),s._v("x或以上版本"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nlog_type的可选值包括："),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("binary")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("error"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("general"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("relay"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("slow\n\n例如截取slow慢查询log，具体的步骤如下：\n\nstep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 刷新慢查询日志文件\nmysqladmin "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p flush"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("logs slow\n\nstep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" 重命名旧慢查询日志\nmv slow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log _del_20200421_slow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\n\nstep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" 生成新慢查询日志文件\nmysqladmin "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p flush"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("logs slow\n\n")])])]),t("p",[t("strong",[s._v("76.查看存储过程或函数的创建代码")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("　　"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" proc_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" func_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h2",{attrs:{id:"参考文章"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),t("ul",[t("li",[s._v("https://www.cnblogs.com/xuliuzai/p/9878586.html")])])])}),[],!1,null,null,null);a.default=r.exports}}]);