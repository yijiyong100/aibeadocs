(window.webpackJsonp=window.webpackJsonp||[]).push([[693],{1209:function(s,t,a){"use strict";a.r(t);var e=a(53),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("本文主要是介绍 监控分析-慢SQL案例操作 。")])]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#一、慢查询日志"}},[s._v("一、慢查询日志")]),a("ul",[a("li",[a("a",{attrs:{href:"#_1、设置慢查询"}},[s._v("1、设置慢查询")])]),a("li",[a("a",{attrs:{href:"#_2、获取慢sql信息"}},[s._v("2、获取慢SQL信息")])]),a("li",[a("a",{attrs:{href:"#_3、搭配日志分析工具mysqldumpslow"}},[s._v("3、搭配日志分析工具mysqldumpslow")])])])]),a("li",[a("a",{attrs:{href:"#二、explain分析慢sql"}},[s._v("二、explain分析慢SQL")])]),a("li",[a("a",{attrs:{href:"#三、show-profile分析慢sql"}},[s._v("三、Show Profile分析慢SQL")]),a("ul",[a("li",[a("a",{attrs:{href:"#_1、默认关闭。开启后-会在后台保存最近15次的运行结果-然后通过show-profile命令查看结果。"}},[s._v("1、默认关闭。开启后，会在后台保存最近15次的运行结果，然后通过Show Profile命令查看结果。")])]),a("li",[a("a",{attrs:{href:"#_2、通过show-profile能查看sql的耗时"}},[s._v("2、通过Show Profile能查看SQL的耗时")])]),a("li",[a("a",{attrs:{href:"#_3、通过query-id可以得到具体sql从连接-服务-引擎-存储四层结构完整生命周期的耗时"}},[s._v("3、通过Query_ID可以得到具体SQL从连接 - 服务 - 引擎 - 存储四层结构完整生命周期的耗时")])]),a("li",[a("a",{attrs:{href:"#_4、出现这四个status时说明有问题-group-by可能会创建临时表"}},[s._v("4、出现这四个status时说明有问题，group by可能会创建临时表")])])])]),a("li",[a("a",{attrs:{href:"#四、全局查询日志"}},[s._v("四、全局查询日志")]),a("ul",[a("li",[a("a",{attrs:{href:"#_1、开启"}},[s._v("1、开启：")])]),a("li",[a("a",{attrs:{href:"#_2、查看"}},[s._v("2、查看")])])])]),a("li",[a("a",{attrs:{href:"#参考文章"}},[s._v("参考文章")])])])]),a("p"),s._v(" "),a("p",[s._v("对慢SQL优化一般可以按下面几步的思路：")]),s._v(" "),a("p",[s._v("1、开启慢查询日志，设置超过几秒为慢SQL，抓取慢SQL")]),s._v(" "),a("p",[s._v("2、通过explain对慢SQL分析（重点）")]),s._v(" "),a("p",[s._v("3、show profile查询SQL在Mysql服务器里的执行细节和生命周期情况（重点）")]),s._v(" "),a("p",[s._v("4、对数据库服务器的参数调优")]),s._v(" "),a("h2",{attrs:{id:"一、慢查询日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、慢查询日志"}},[s._v("#")]),s._v(" 一、慢查询日志")]),s._v(" "),a("h3",{attrs:{id:"_1、设置慢查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、设置慢查询"}},[s._v("#")]),s._v(" 1、设置慢查询")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("（1）设置开启：SET GLOBAL slow_query_log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("　　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#默认未开启，开启会影响性能，mysql重启会失效")]),s._v("\n（2）查看是否开启：SHOW VARIABLES LIKE "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%slow_query_log%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n（3）设置阈值：SET GLOBAL "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("long_query_time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n（4）查看阈值：SHOW 【GLOBAL】 VARIABLES LIKE "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'long_query_time%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#重连或新开一个会话才能看到修改值")]),s._v("\n（5）通过修改配置文件my.cnf永久生效，在"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mysqld"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("下配置：\n　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mysqld"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n　　slow_query_log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启")]),s._v("\n　　"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("slow_query_log_file")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lib/mysql/atguigu-slow.log　　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#慢日志地址，缺省文件名host_name-slow.log")]),s._v("\n　　"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("long_query_time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("　　  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#运行时间超过该值的SQL会被记录，默认值>10")]),s._v("\n　　"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("log_output")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("FILE　　　　　　　　　　　\n")])])]),a("h3",{attrs:{id:"_2、获取慢sql信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、获取慢sql信息"}},[s._v("#")]),s._v(" 2、获取慢SQL信息")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("查看慢查询日志记录数：SHOW GLOBAL STATUS LIKE "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%Slow_queries%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("模拟语句：select sleep(4);")]),s._v(" "),a("p",[s._v("查看日志：cat atguigu-slow.log")]),s._v(" "),a("p",[a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/monitorsql/slowsqlcase-1.png"),alt:"wxmp"}})]),s._v(" "),a("h3",{attrs:{id:"_3、搭配日志分析工具mysqldumpslow"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、搭配日志分析工具mysqldumpslow"}},[s._v("#")]),s._v(" 3、搭配日志分析工具mysqldumpslow")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mysqldumpslow -s r -t "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" /var/lib/mysql/atguigu-slow.log     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#得到返回记录集最多的10个SQL")]),s._v("\nmysqldumpslow -s c -t "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" /var/lib/mysql/atguigu-slow.log     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#得到访问次数最多的10个SQL")]),s._v("\nmysqldumpslow -s t -t "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" -g "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"LEFT JOIN"')]),s._v(" /var/lib/mysql/atguigu-slow.log   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#得到按照时间排序的前10条里面含有左连接的查询语句")]),s._v("\nmysqldumpslow -s r -t "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" /var/lib/mysql/atguigu-slow.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#结合| more使用，防止爆屏情况")]),s._v("\n\ns：表示按何种方式排序\nc：访问次数\nl：锁定时间\nr：返回记录\nt：查询时间\nal：平均锁定时间\nar：平均返回记录数\nat：平均查询时间\nt：返回前面多少条的数据\ng：后边搭配一个正则匹配模式，大小写不敏感\n")])])]),a("h2",{attrs:{id:"二、explain分析慢sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、explain分析慢sql"}},[s._v("#")]),s._v(" 二、explain分析慢SQL")]),s._v(" "),a("p",[s._v("通过"),a("strong",[s._v("explain")]),s._v("分析慢SQL很重要，单独一章列举，"),a("a",{attrs:{href:"https://www.cnblogs.com/zjxiang/p/9160564.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("MySQL优化(4)：explain分析"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"三、show-profile分析慢sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、show-profile分析慢sql"}},[s._v("#")]),s._v(" 三、Show Profile分析慢SQL")]),s._v(" "),a("p",[a("strong",[s._v("Show Profile")]),s._v("也是分析慢SQL的一种手段，但它能获得比explain更详细的信息，能分析当前会话中语句执行的资源消耗情况，能获得这条SQL在整个生命周期的耗时，相当于执行时间的清单，也很重要。")]),s._v(" "),a("h3",{attrs:{id:"_1、默认关闭。开启后-会在后台保存最近15次的运行结果-然后通过show-profile命令查看结果。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、默认关闭。开启后-会在后台保存最近15次的运行结果-然后通过show-profile命令查看结果。"}},[s._v("#")]),s._v(" 1、默认关闭。开启后，会在后台保存最近15次的运行结果，然后通过Show Profile命令查看结果。")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("开启：set profiling "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n查看：SHOW VARIABLES LIKE "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'profiling%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("h3",{attrs:{id:"_2、通过show-profile能查看sql的耗时"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、通过show-profile能查看sql的耗时"}},[s._v("#")]),s._v(" 2、通过Show Profile能查看SQL的耗时")]),s._v(" "),a("p",[a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/monitorsql/slowsqlcase-2.png"),alt:"wxmp"}})]),s._v(" "),a("h3",{attrs:{id:"_3、通过query-id可以得到具体sql从连接-服务-引擎-存储四层结构完整生命周期的耗时"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、通过query-id可以得到具体sql从连接-服务-引擎-存储四层结构完整生命周期的耗时"}},[s._v("#")]),s._v(" 3、通过Query_ID可以得到具体SQL从连接 - 服务 - 引擎 - 存储四层结构完整生命周期的耗时")]),s._v(" "),a("p",[a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/monitorsql/slowsqlcase-3.png"),alt:"wxmp"}})]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("可用参数type:\nALL  　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#显示所有的开销信息")]),s._v("\nBLOCK IO　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#显示块IO相关开销")]),s._v("\nCONTEXT SWITCHES　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#上下文切换相关开销")]),s._v("\nCPU     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#显示CPU相关开销信息")]),s._v("\nIPC     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#显示发送和接收相关开销信息")]),s._v("\nMEMORY　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#显示内存相关开销信息")]),s._v("\nPAGE FAULTS　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#显示页面错误相关开销信息")]),s._v("\nSOURCE　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#显示和Source_function，Source_file，Source_line相关的开销信息")]),s._v("\nSWAPS　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#显示交换次数相关开销的信息")]),s._v("\n")])])]),a("h3",{attrs:{id:"_4、出现这四个status时说明有问题-group-by可能会创建临时表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、出现这四个status时说明有问题-group-by可能会创建临时表"}},[s._v("#")]),s._v(" 4、出现这四个status时说明有问题，group by可能会创建临时表")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#危险状态：converting HEAP to MyISAM  　　#查询结果太大，内存不够用了，在往磁盘上搬")]),s._v("\nCreating tmp table         　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#创建了临时表，回先把数据拷贝到临时表，用完后再删除临时表")]),s._v("\nCopying to tmp table on disk 　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#把内存中临时表复制到磁盘，危险！！！")]),s._v("\nlocked\n")])])]),a("p",[a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/monitorsql/slowsqlcase-4.png"),alt:"wxmp"}})]),s._v(" "),a("h2",{attrs:{id:"四、全局查询日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、全局查询日志"}},[s._v("#")]),s._v(" 四、全局查询日志")]),s._v(" "),a("p",[s._v("只在测试环境用，别在生产环境用，会记录所有使用过的SQL")]),s._v(" "),a("h3",{attrs:{id:"_1、开启"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、开启"}},[s._v("#")]),s._v(" 1、开启：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("开启：会将sql记录到mysql库的general_log表\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" global "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("general_log")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" global "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("log_output")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'TABLE'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n配置文件的方式：\n    在my.cnf中配置\n    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("general_log")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("general_log_file")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/path/logfile    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#记录日志文件的路径")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("log_output")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("FILE    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#输出格式")]),s._v("\n")])])]),a("h3",{attrs:{id:"_2、查看"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、查看"}},[s._v("#")]),s._v(" 2、查看")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("select * from mysql.general_log;\n")])])]),a("p",[a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s.$withBase("/assets/img/mysqlop/monitorsql/slowsqlcase-5.png"),alt:"wxmp"}})]),s._v(" "),a("p",[a("strong",[s._v("EOF")])]),s._v(" "),a("p",[a("strong",[s._v("本文作者")]),s._v("：**"),a("a",{attrs:{href:"https://www.cnblogs.com/zjxiang/p/9157398.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("愿起起起起落起起起起起"),a("OutboundLink")],1),s._v(" "),a("strong",[s._v("本文链接")]),s._v("：https://www.cnblogs.com/zjxiang/p/9157398.html")]),s._v(" "),a("p",[a("strong",[s._v("关于博主")]),s._v("：评论和私信会在第一时间回复。或者"),a("a",{attrs:{href:"https://msg.cnblogs.com/msg/send/zjxiang",target:"_blank",rel:"noopener noreferrer"}},[s._v("直接私信"),a("OutboundLink")],1),s._v("我。")]),s._v(" "),a("p",[a("strong",[s._v("版权声明")]),s._v("：本博客所有文章除特别声明外，均采用 "),a("a",{attrs:{href:"https://creativecommons.org/licenses/by-nc-nd/4.0/",target:"_blank",rel:"noopener noreferrer"}},[s._v("BY-NC-SA"),a("OutboundLink")],1),s._v(" 许可协议。转载请注明出处！")]),s._v(" "),a("p",[a("strong",[s._v("声援博主")]),s._v("：如果您觉得文章对您有帮助，可以点击文章右下角**【[推荐](javascript:void(0)😉】**一下。您的鼓励是博主的最大动力！")]),s._v(" "),a("h2",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),a("ul",[a("li",[s._v("https://www.cnblogs.com/zjxiang/p/9157398.html")])])])}),[],!1,null,null,null);t.default=r.exports}}]);